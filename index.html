<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Reality Pets: Grime & Grooves</title>
  <style>
    :root { 
      --glass: rgba(0, 0, 0, 0.85); 
      --gold: #ffcc00;
      --safe-top: env(safe-area-inset-top, 59px); 
      --safe-bottom: env(safe-area-inset-bottom, 50px);
    }
    
    body {
      margin: 0; font-family: -apple-system, sans-serif;
      background: #1a1a1a url('bg_wp.jpg') no-repeat center center fixed;
      background-size: cover; color: #fff; 
      height: 100vh; height: -webkit-fill-available;
      overflow: hidden; position: fixed; width: 100%;
      -webkit-user-select: none; user-select: none;
    }

    /* HUD - Centered below Island */
    #hud {
      position: absolute; top: calc(var(--safe-top) + 10px); left: 50%;
      transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; align-items: center; gap: 8px;
    }

    #statsBox {
      background: var(--glass); padding: 8px 16px; border-radius: 20px;
      font-size: 11px; backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1);
      display: flex; gap: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }

    /* Audio Controls */
    .audio-controls {
      display: flex; gap: 5px; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 15px; backdrop-filter: blur(10px);
    }
    .audio-controls button { background: none; border: none; color: white; font-size: 16px; padding: 2px 8px; }

    /* Grime Effects */
    .fly { position: absolute; font-size: 12px; animation: flyBuzz 0.5s infinite alternate; pointer-events: none; }
    @keyframes flyBuzz { 0% { transform: translate(0,0); } 100% { transform: translate(5px, -5px); } }
    
    .mess { position: absolute; font-size: 24px; pointer-events: none; z-index: 4; transition: opacity 0.5s; }

    /* Action Bar */
    .action-bar {
      position: absolute; bottom: calc(var(--safe-bottom) + 35px);
      left: 50%; transform: translateX(-50%);
      display: flex; gap: 10px; z-index: 9999;
      background: rgba(0,0,0,0.7); padding: 10px 15px; border-radius: 30px;
      backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1);
    }

    .action-bar button {
      background: #2a2a2a; border: 1px solid #444;
      color: white; border-radius: 50%; width: 52px; height: 52px; font-size: 24px;
      display: flex; align-items: center; justify-content: center;
    }

    /* Pet Logic */
    #game-world { position: absolute; z-index: 10; transition: all 0.8s ease; pointer-events: none; }
    .pet-img { filter: drop-shadow(0 0 10px rgba(255,255,255,0.3)); cursor: pointer; pointer-events: auto; }
    .wander { animation: wander 14s linear infinite alternate; }
    @keyframes wander { 0% { transform: translate(-50px, 0); } 100% { transform: translate(50px, 0); } }
    .react { animation: react 0.4s ease-out; }
    @keyframes react { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
    
    /* Animations */
    .food-drop { position: absolute; font-size: 45px; z-index: 50; animation: fall 1.2s ease-in forwards; }
    @keyframes fall { 0% { transform: translateY(-50px); opacity: 1; } 100% { transform: translateY(500px); opacity: 0; } }
    .pop { position: absolute; font-size: 35px; animation: popUp 1.2s forwards; z-index: 10001; pointer-events: none; }
    @keyframes popUp { 0% { opacity: 1; } 100% { transform: translateY(-100px); opacity: 0; } }
  </style>
</head>
<body onclick="handlePetting(event)">

  <div id="hud">
    <div id="statsBox">
      <div id="sn"><b>‚Äî</b></div>
      <div id="sh">H: ‚Äî</div>
      <div id="se">E: ‚Äî</div>
      <div id="shp">HP: ‚Äî</div>
    </div>
    <div class="audio-controls">
      <button onclick="setVol(0, event)">üîà</button>
      <button onclick="setVol(0.4, event)">üîâ</button>
      <button onclick="setVol(0.8, event)">üîä</button>
    </div>
  </div>

  <div id="game-world"></div>
  <div id="messes"></div>

  <div class="action-bar">
    <button onclick="feedPet(event)">üçé</button>
    <button onclick="cleanPet(event)">üßΩ</button>
    <button onclick="playPet(event)">‚öΩÔ∏è</button>
    <button onclick="doctorPet(event)">ü©∫</button>
    <button id="resBtn" onclick="resurrectPet(event)" style="display:none; background:var(--gold); color:black;">‚ö°Ô∏è</button>
    <button onclick="toggleSleep(event)">üåô</button>
  </div>

  <audio id="bgMusic" loop src="happy-day.mp3"></audio>

  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = { apiKey: "AIzaSyDkpW7RAmX0wPmL757_GzEFIoU6snssLnA", authDomain: "pets-86c25.firebaseapp.com", projectId: "pets-86c25", storageBucket: "pets-86c25.firebasestorage.app", messagingSenderId: "556129222317", appId: "1:556129222317:web:12d323a5165eb222d59024" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let pet = null;
    let isSleeping = false;
    const bgMusic = document.getElementById('bgMusic');
    const foodMap = { bunny:"ü•ï", fox:"üçî", dog:"ü•©", dragon:"üçñ", cat:"üê†", unicorn:"üçé", frog:"ü™∞" };
    const reactMap = { bunny: "üê∞", fox: "ü¶ä", dog: "üêï", cat: "üòº", frog: "üê∏", dragon: "üî•", unicorn: "‚ú®" };
    const petPositions = { frog: { left: "25%", bottom: "25%" }, bunny: { left: "65%", bottom: "28%" }, fox: { left: "55%", bottom: "30%" }, dog: { left: "50%", bottom: "32%" }, cat: { left: "45%", bottom: "34%" }, unicorn: { left: "70%", bottom: "36%" }, dragon: { left: "50%", bottom: "60%" } };

    function display(data) {
      pet = data;
      const world = document.getElementById("game-world");
      const isDead = pet.stats.health <= 0;
      const size = 80 + (pet.stats.level * 5);
      const pos = petPositions[pet.species] || { left:"50%", bottom:"32%" };

      world.style.left = pos.left;
      world.style.bottom = pos.bottom;
      world.classList.toggle("wander", ["bunny", "fox", "dog", "cat"].includes(pet.species) && !isDead);
      world.innerHTML = `<img src="${pet.species}.png" class="pet-img ${isDead ? 'is-ghost' : ''}" style="width:${size}px">`;
      
      handleGrime();
      document.getElementById("resBtn").style.display = isDead ? "flex" : "none";
      updateUI();
    }

    function handleGrime() {
      const world = document.getElementById("game-world");
      // Remove old flies
      document.querySelectorAll('.fly').forEach(f => f.remove());
      // If health low or hunger high, add flies
      if (pet.stats.health < 60 || pet.stats.hunger > 80) {
        for(let i=0; i<3; i++) {
          const fly = document.createElement('div');
          fly.className = 'fly'; fly.innerText = 'ü™∞';
          fly.style.left = Math.random() * 50 + 'px';
          fly.style.top = Math.random() * 50 + 'px';
          world.appendChild(fly);
        }
        // Occasional mess on floor
        if (Math.random() > 0.8) spawnMess();
      }
    }

    function spawnMess() {
      const container = document.getElementById('messes');
      const mess = document.createElement('div');
      mess.className = 'mess'; mess.innerText = 'üí©';
      mess.style.left = (Math.random() * 60 + 20) + '%';
      mess.style.bottom = '20%';
      container.appendChild(mess);
    }

    function cleanPet(e) {
      e.stopPropagation();
      if(!pet || pet.stats.health <= 0) return;
      pet.stats.health = Math.min(100, pet.stats.health + 15);
      document.querySelectorAll('.mess').forEach(m => m.style.opacity = '0');
      setTimeout(() => document.getElementById('messes').innerHTML = '', 500);
      spawnPop("ü´ßüßπ", window.innerWidth/2, window.innerHeight/2);
      handleGrime();
      save();
    }

    // --- SEAMLESS AUDIO ENGINE ---
let audioCtx, audioBuffer, sourceNode, gainNode;

async function initSeamlessAudio() {
  if (audioCtx) return; // Don't re-init if already running
  
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  gainNode = audioCtx.createGain();
  gainNode.connect(audioCtx.destination);

  try {
    const response = await fetch('happy-day.mp3');
    const arrayBuffer = await response.arrayBuffer();
    audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
    
    // Create and start the loop
    sourceNode = audioCtx.createBufferSource();
    sourceNode.buffer = audioBuffer;
    sourceNode.loop = true; // High-performance looping (No Hiccups!)
    sourceNode.connect(gainNode);
    sourceNode.start(0);
  } catch (err) {
    console.error("Audio Load Error:", err);
  }
}

function setVol(val, e) {
  if (e) e.stopPropagation();
  
  // Unlock audio engine for Safari on first tap
  if (!audioCtx) {
    initSeamlessAudio();
    // Give it a second to load before setting volume
    setTimeout(() => { if(gainNode) gainNode.gain.value = val; }, 500);
    return;
  }

  if (audioCtx.state === 'suspended') audioCtx.resume();

  // Smooth Volume Ramp (Prevents "popping" sounds)
  gainNode.gain.setTargetAtTime(val, audioCtx.currentTime, 0.1);
}

// --- UPDATED SLEEP FUNCTION (With Fade) ---
function toggleSleep(e) {
  e.stopPropagation();
  isSleeping = !isSleeping;
  
  document.body.style.filter = isSleeping ? "brightness(0.4)" : "none";
  
  // Automatically lower volume if sleeping, bring it back if awake
  if (gainNode) {
    const targetVol = isSleeping ? 0.1 : 0.5; // Dims music to 10%
    gainNode.gain.setTargetAtTime(targetVol, audioCtx.currentTime, 1.5);
  }
  
  save();
}


    function handlePetting(e) {
      if (!pet || isSleeping || pet.stats.health <= 0) return;
      if (e.target.classList.contains('pet-img')) {
        e.target.classList.remove("react"); void e.target.offsetWidth; e.target.classList.add("react");
        pet.stats.xp = (pet.stats.xp || 0) + 5;
        spawnPop(reactMap[pet.species] || "üíï", e.clientX, e.clientY);
        if (pet.stats.xp >= 100) { pet.stats.level++; pet.stats.xp = 0; display(pet); }
        save();
      }
    }

    function feedPet(e) { 
      e.stopPropagation(); 
      if(!pet || isSleeping || pet.stats.health <= 0) return; 
      pet.stats.hunger = Math.max(0, pet.stats.hunger - 20); 
      const f = document.createElement("div"); f.className = "food-drop"; f.innerText = foodMap[pet.species]; f.style.left = "50%";
      document.body.appendChild(f); setTimeout(() => f.remove(), 1200);
      save(); 
    }

    function playPet(e) { e.stopPropagation(); if(!pet || isSleeping || pet.stats.health <= 0) return; pet.stats.energy = Math.max(0, pet.stats.energy - 15); spawnPop("‚öΩÔ∏è", window.innerWidth/2, window.innerHeight/2); save(); }
    function doctorPet(e) { e.stopPropagation(); if(!pet || isSleeping || pet.stats.health <= 0) return; pet.stats.health = Math.min(100, pet.stats.health + 40); save(); }
    function resurrectPet(e) { e.stopPropagation(); pet.stats = { hunger: 50, energy: 50, health: 100, level: 1, xp: 0 }; display(pet); save(); }
    

    function spawnPop(txt, x, y) {
      const p = document.createElement("div"); p.className = "pop"; p.innerText = txt;
      p.style.left = (x - 20) + "px"; p.style.top = (y - 20) + "px";
      document.body.appendChild(p); setTimeout(() => p.remove(), 1200);
    }

    function updateUI() {
      if (!pet) return;
      const s = pet.stats;
      document.getElementById("sn").innerHTML = `<b>${pet.name}</b>`;
      document.getElementById("sh").innerText = `H: ${Math.round(s.hunger)}%`;
      document.getElementById("se").innerText = `E: ${Math.round(s.energy)}%`;
      document.getElementById("shp").innerText = `HP: ${Math.round(s.health)}%`;
    }

    async function save() { if(pet.id) await db.collection("pets").doc(pet.id).update({ stats: pet.stats, lastUpdated: Date.now() }); updateUI(); }
    
    async function fetchPet() {
      const snap = await db.collection("pets").orderBy("lastUpdated", "desc").limit(1).get();
      if (!snap.empty) display({ id: snap.docs[0].id, ...snap.docs[0].data() });
    }
    fetchPet();
  </script>
</body>
</html>
