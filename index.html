<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Reality Pets: Safari Pro</title>
  <style>
    :root { 
      --glass: rgba(0, 0, 0, 0.85); 
      --gold: #ffcc00;
      --safe-top: env(safe-area-inset-top, 59px); 
      /* Increased bottom buffer for Safari address bar */
      --safe-bottom: env(safe-area-inset-bottom, 50px);
    }
    
    body {
      margin: 0; font-family: -apple-system, sans-serif;
      background: #1a1a1a url('bg_wp.jpg') no-repeat center center fixed;
      background-size: cover; color: #fff; 
      /* Force body to stay within visible window */
      height: 100vh; height: -webkit-fill-available;
      overflow: hidden; position: fixed; width: 100%;
      -webkit-user-select: none; user-select: none;
    }

    /* Centered Stat HUD */
    #statsBox {
      position: absolute; 
      top: calc(var(--safe-top) + 10px); 
      left: 50%;
      transform: translateX(-50%);
      background: var(--glass); 
      padding: 8px 16px; 
      border-radius: 20px;
      font-size: 11px; 
      backdrop-filter: blur(15px); 
      z-index: 9999;
      border: 1px solid rgba(255,255,255,0.1);
      display: flex; gap: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }

    .menu-wrap { 
      position: absolute; 
      top: calc(var(--safe-top) + 10px); 
      left: 15px; 
      z-index: 10000;
    }

    /* Action Bar - Pushed UP away from Safari bar */
    .action-bar {
      position: absolute; 
      bottom: calc(var(--safe-bottom) + 35px); /* Lifted higher */
      left: 50%; 
      transform: translateX(-50%);
      display: flex; 
      gap: 10px; 
      z-index: 9999;
      background: rgba(0,0,0,0.7); 
      padding: 10px 15px; 
      border-radius: 30px;
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.1);
    }

    .action-bar button {
      background: #2a2a2a; border: 1px solid #444;
      color: white; border-radius: 50%; width: 52px; height: 52px; font-size: 24px;
      display: flex; align-items: center; justify-content: center;
    }

    /* Pet Logic */
    #game-world { position: absolute; z-index: 10; transition: all 0.8s ease; pointer-events: none; }
    .pet-img { filter: drop-shadow(0 0 10px rgba(255,255,255,0.3)); cursor: pointer; pointer-events: auto; }
    
    .wander { animation: wander 14s linear infinite alternate; }
    @keyframes wander { 0% { transform: translate(-50px, 0); } 100% { transform: translate(50px, 0); } }
    
    .react { animation: react 0.4s ease-out; }
    @keyframes react { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
    
    .is-ghost { filter: grayscale(1) opacity(0.3) drop-shadow(0 0 15px cyan) !important; }

    .food-drop {
      position: absolute; font-size: 45px; z-index: 50;
      animation: fall 1.2s ease-in forwards;
    }
    @keyframes fall {
      0% { transform: translateY(-50px); opacity: 1; }
      100% { transform: translateY(500px); opacity: 0; }
    }

    .pop { position: absolute; font-size: 35px; animation: popUp 1.2s forwards; z-index: 10001; pointer-events: none; }
    @keyframes popUp { 0% { opacity: 1; } 100% { transform: translateY(-100px); opacity: 0; } }
  </style>
</head>
<body onclick="handlePetting(event)">

  <div class="menu-wrap">
    <button onclick="toggleMenu(event)" style="background:var(--glass); color:white; border:none; border-radius:50%; width:44px; height:44px; font-size:20px;">‚öôÔ∏è</button>
    <div id="createMenu" style="display:none; background:var(--glass); padding:15px; border-radius:15px; margin-top:10px; width:170px; box-shadow: 0 10px 30px rgba(0,0,0,0.8);">
      <input id="petName" placeholder="Name" style="width:90%; margin-bottom:8px; padding:8px; border-radius:5px; border:none;">
      <select id="petSpecies" style="width:100%; margin-bottom:8px; padding:8px; border-radius:5px;">
        <option value="bunny">Bunny</option><option value="fox">Fox</option>
        <option value="dog">Dog</option><option value="dragon">Dragon</option>
        <option value="cat">Cat</option><option value="unicorn">Unicorn</option>
        <option value="frog">Frog</option>
      </select>
      <button onclick="createPet()" style="width:100%; background:var(--gold); border:none; padding:10px; border-radius:8px; font-weight:bold; color:black;">ADOPT</button>
    </div>
  </div>

  <div id="statsBox">
    <div id="sn"><b>‚Äî</b></div>
    <div id="sh">H: ‚Äî</div>
    <div id="se">E: ‚Äî</div>
    <div id="shp">HP: ‚Äî</div>
  </div>

  <div id="game-world"></div>

  <div class="action-bar">
    <button onclick="feedPet(event)">üçé</button>
    <button onclick="cleanPet(event)">üßΩ</button>
    <button onclick="playPet(event)">‚öΩÔ∏è</button>
    <button onclick="doctorPet(event)">ü©∫</button>
    <button id="resBtn" onclick="resurrectPet(event)" style="display:none; background:var(--gold); color:black;">‚ö°Ô∏è</button>
    <button onclick="toggleSleep(event)">üåô</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = { apiKey: "AIzaSyDkpW7RAmX0wPmL757_GzEFIoU6snssLnA", authDomain: "pets-86c25.firebaseapp.com", projectId: "pets-86c25", storageBucket: "pets-86c25.firebasestorage.app", messagingSenderId: "556129222317", appId: "1:556129222317:web:12d323a5165eb222d59024" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let pet = null;
    let isSleeping = false;
    const foodMap = { bunny:"ü•ï", fox:"üçî", dog:"ü•©", dragon:"üçñ", cat:"üê†", unicorn:"üçé", frog:"ü™∞" };
    const reactMap = { bunny: "üê∞", fox: "ü¶ä", dog: "üêï", cat: "üòº", frog: "üê∏", dragon: "üî•", unicorn: "‚ú®" };
    const petPositions = { frog: { left: "25%", bottom: "25%" }, bunny: { left: "65%", bottom: "28%" }, fox: { left: "55%", bottom: "30%" }, dog: { left: "50%", bottom: "32%" }, cat: { left: "45%", bottom: "34%" }, unicorn: { left: "70%", bottom: "36%" }, dragon: { left: "50%", bottom: "60%" } };
    const roamingPets = ["bunny", "fox", "dog", "cat"];

    function display(data) {
      pet = data;
      const world = document.getElementById("game-world");
      const isDead = pet.stats.health <= 0;
      const size = 80 + (pet.stats.level * 5);
      const pos = petPositions[pet.species] || { left:"50%", bottom:"32%" };

      world.style.left = pos.left;
      world.style.bottom = pos.bottom;
      world.classList.toggle("wander", roamingPets.includes(pet.species) && !isDead);
      world.innerHTML = `<img src="${pet.species}.png" class="pet-img ${isDead ? 'is-ghost' : ''}" style="width:${size}px">`;
      document.getElementById("resBtn").style.display = isDead ? "flex" : "none";
      updateUI();
    }

    function handlePetting(e) {
      if (!pet || isSleeping || pet.stats.health <= 0) return;
      if (e.target.classList.contains('pet-img')) {
        e.target.classList.remove("react"); void e.target.offsetWidth; e.target.classList.add("react");
        pet.stats.xp = (pet.stats.xp || 0) + 5;
        spawnPop(reactMap[pet.species] || "üíï", e.clientX, e.clientY);
        checkGrowth(); save();
      }
    }

    function feedPet(e) { 
      e.stopPropagation(); 
      if(!pet || isSleeping || pet.stats.health <= 0) return; 
      pet.stats.hunger = Math.max(0, pet.stats.hunger - 20); 
      const food = document.createElement("div");
      food.className = "food-drop";
      food.innerText = foodMap[pet.species];
      food.style.left = "50%";
      document.body.appendChild(food);
      setTimeout(() => food.remove(), 1200);
      save(); 
    }

    function cleanPet(e) { e.stopPropagation(); if(!pet || isSleeping || pet.stats.health <= 0) return; pet.stats.health = Math.min(100, pet.stats.health + 10); spawnPop("ü´ß", window.innerWidth/2, window.innerHeight/2); save(); }
    function playPet(e) { e.stopPropagation(); if(!pet || isSleeping || pet.stats.health <= 0) return; pet.stats.energy = Math.max(0, pet.stats.energy - 15); spawnPop("‚öΩÔ∏è", window.innerWidth/2, window.innerHeight/2); save(); }
    function doctorPet(e) { e.stopPropagation(); if(!pet || isSleeping || pet.stats.health <= 0) return; pet.stats.health = Math.min(100, pet.stats.health + 40); save(); }
    function resurrectPet(e) { e.stopPropagation(); pet.stats = { hunger: 50, energy: 50, health: 100, level: 1, xp: 0 }; display(pet); save(); }
    function toggleSleep(e) { e.stopPropagation(); isSleeping = !isSleeping; document.body.style.filter = isSleeping ? "brightness(0.4)" : "none"; save(); }
    function toggleMenu(e) { e.stopPropagation(); const m = document.getElementById('createMenu'); m.style.display = m.style.display === 'block' ? 'none' : 'block'; }

    function spawnPop(txt, x, y) {
      const p = document.createElement("div"); p.className = "pop"; p.innerText = txt;
      p.style.left = (x - 20) + "px"; p.style.top = (y - 20) + "px";
      document.body.appendChild(p); setTimeout(() => p.remove(), 1200);
    }

    function updateUI() {
      if (!pet) return;
      const s = pet.stats;
      document.getElementById("sn").innerHTML = `<b>${pet.name}</b>`;
      document.getElementById("sh").innerText = `H: ${Math.round(s.hunger)}%`;
      document.getElementById("se").innerText = `E: ${Math.round(s.energy)}%`;
      document.getElementById("shp").innerText = `HP: ${Math.round(s.health)}%`;
    }

    async function save() { if(pet.id) await db.collection("pets").doc(pet.id).update({ stats: pet.stats, lastUpdated: Date.now() }); updateUI(); }
    function checkGrowth() { if (pet.stats.xp >= 100) { pet.stats.level++; pet.stats.xp = 0; display(pet); } }
    
    async function createPet() {
      const n = document.getElementById("petName").value;
      const s = document.getElementById("petSpecies").value;
      if (!n) return;
      const res = await db.collection("pets").add({ name: n, species: s, lastUpdated: Date.now(), stats: { hunger: 50, energy: 50, health: 100, level: 1, xp: 0 } });
      display({ id: res.id, name: n, species: s, stats: { hunger: 50, energy: 50, health: 100, level: 1, xp: 0 } });
      document.getElementById('createMenu').style.display = 'none';
    }

    async function fetchPet() {
      const snap = await db.collection("pets").orderBy("lastUpdated", "desc").limit(1).get();
      if (!snap.empty) display({ id: snap.docs[0].id, ...snap.docs[0].data() });
    }
    fetchPet();
  </script>
</body>
</html>
