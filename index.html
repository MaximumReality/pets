<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Reality Pets: Final Fix</title>
  <style>
    :root { 
      --glass: rgba(0, 0, 0, 0.85); 
      --gold: #ffcc00;
      --safe-top: env(safe-area-inset-top, 50px); 
    }
    
    body {
      margin: 0; font-family: -apple-system, sans-serif;
      background: #1a1a1a url('bg_wp.jpg') no-repeat center center fixed;
      background-size: cover; color: #fff; overflow: hidden; height: 100vh;
      -webkit-user-select: none; user-select: none;
    }

    /* Stats - Pushed down to clear Dynamic Island */
    #statsBox {
      position: absolute; top: calc(var(--safe-top) + 10px); right: 15px;
      background: var(--glass); padding: 10px; border-radius: 15px;
      font-size: 11px; backdrop-filter: blur(10px); z-index: 1000;
      border: 1px solid rgba(255,255,255,0.1); width: 130px;
    }

    .menu-wrap { 
      position: absolute; top: calc(var(--safe-top) + 10px); left: 15px; 
      z-index: 1000;
    }

    /* Action Bar - Solid Z-Index and Flex */
    .action-bar {
      position: absolute; bottom: env(safe-area-inset-bottom, 30px);
      left: 50%; transform: translateX(-50%);
      display: flex; gap: 12px; z-index: 1000;
      background: rgba(0,0,0,0.6); padding: 12px; border-radius: 30px;
      backdrop-filter: blur(15px);
    }

    .action-bar button {
      background: #333; border: 1px solid #555;
      color: white; border-radius: 50%; width: 50px; height: 50px; font-size: 24px;
      display: flex; align-items: center; justify-content: center;
    }

    /* Pet Logic */
    #game-world { position: absolute; z-index: 5; transition: all 0.8s ease; }
    .pet-img { filter: drop-shadow(0 0 10px rgba(255,255,255,0.3)); cursor: pointer; }
    
    .wander { animation: wander 14s linear infinite alternate; }
    @keyframes wander { 0% { transform: translate(-80px, 0); } 100% { transform: translate(80px, 0); } }
    
    .react { animation: react 0.4s ease-out; }
    @keyframes react { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
    
    .is-ghost { filter: grayscale(1) opacity(0.3) drop-shadow(0 0 15px cyan) !important; }

    /* Falling Food Animation */
    .food-drop {
      position: absolute; font-size: 40px; z-index: 100;
      animation: fall 1.5s ease-in forwards;
    }
    @keyframes fall {
      0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(600px) rotate(360deg); opacity: 0; }
    }

    .pop { position: absolute; font-size: 35px; animation: popUp 1.2s forwards; z-index: 2000; pointer-events: none; }
    @keyframes popUp { 0% { opacity: 1; } 100% { transform: translateY(-100px); opacity: 0; } }
  </style>
</head>
<body onclick="handlePetting(event)">

  <div class="menu-wrap">
    <button onclick="toggleMenu(event)" style="background:var(--glass); color:white; border:none; border-radius:50%; width:44px; height:44px; font-size:20px;">âš™ï¸</button>
    <div id="createMenu" style="display:none; background:var(--glass); padding:15px; border-radius:15px; margin-top:10px; width:160px;">
      <input id="petName" placeholder="Name" style="width:90%; margin-bottom:5px; padding:5px;">
      <select id="petSpecies" style="width:98%; margin-bottom:5px; padding:5px;">
        <option value="bunny">Bunny (ğŸ¥•)</option>
        <option value="fox">Fox (ğŸ”)</option>
        <option value="dog">Dog (ğŸ¥©)</option>
        <option value="dragon">Dragon (ğŸ–)</option>
        <option value="cat">Cat (ğŸ )</option>
        <option value="unicorn">Unicorn (ğŸ)</option>
        <option value="frog">Frog (ğŸª°)</option>
      </select>
      <button onclick="createPet()" style="width:100%; background:var(--gold); border:none; padding:10px; border-radius:8px; font-weight:bold;">ADOPT</button>
    </div>
  </div>

  <div id="statsBox">
    <div id="sn"><b>Adopt a Pet!</b></div>
    <div id="sh">Hunger: â€”</div>
    <div id="se">Energy: â€”</div>
    <div id="shp">Health: â€”</div>
    <div id="sl">Level: â€”</div>
  </div>

  <div id="game-world"></div>

  <div class="action-bar">
    <button onclick="feedPet(event)">ğŸ</button>
    <button onclick="cleanPet(event)">ğŸ§½</button>
    <button onclick="playPet(event)">âš½ï¸</button>
    <button onclick="doctorPet(event)">ğŸ©º</button>
    <button id="resBtn" onclick="resurrectPet(event)" style="display:none; background:var(--gold);">âš¡ï¸</button>
    <button onclick="toggleSleep(event)">ğŸŒ™</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = { apiKey: "AIzaSyDkpW7RAmX0wPmL757_GzEFIoU6snssLnA", authDomain: "pets-86c25.firebaseapp.com", projectId: "pets-86c25", storageBucket: "pets-86c25.firebasestorage.app", messagingSenderId: "556129222317", appId: "1:556129222317:web:12d323a5165eb222d59024" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let pet = null;
    let isSleeping = false;
    const foodMap = { bunny:"ğŸ¥•", fox:"ğŸ”", dog:"ğŸ¥©", dragon:"ğŸ–", cat:"ğŸ ", unicorn:"ğŸ", frog:"ğŸª°" };
    const reactMap = { bunny: "ğŸ°", fox: "ğŸ¦Š", dog: "ğŸ•", cat: "ğŸ˜¼", frog: "ğŸ¸", dragon: "ğŸ”¥", unicorn: "âœ¨" };
    const petPositions = { frog: { left: "25%", bottom: "18%" }, bunny: { left: "65%", bottom: "20%" }, fox: { left: "55%", bottom: "22%" }, dog: { left: "50%", bottom: "25%" }, cat: { left: "45%", bottom: "26%" }, unicorn: { left: "70%", bottom: "28%" }, dragon: { left: "50%", bottom: "55%" } };
    const roamingPets = ["bunny", "fox", "dog", "cat"];

    function display(data) {
      pet = data;
      const world = document.getElementById("game-world");
      const isDead = pet.stats.health <= 0;
      const size = 80 + (pet.stats.level * 5);
      const pos = petPositions[pet.species] || { left:"50%", bottom:"28%" };

      world.style.left = pos.left;
      world.style.bottom = pos.bottom;
      world.classList.toggle("wander", roamingPets.includes(pet.species) && !isDead);
      world.innerHTML = `<img src="${pet.species}.png" class="pet-img ${isDead ? 'is-ghost' : ''}" style="width:${size}px">`;
      document.getElementById("resBtn").style.display = isDead ? "flex" : "none";
      updateUI();
    }

    function handlePetting(e) {
      if (!pet || isSleeping || pet.stats.health <= 0) return;
      if (e.target.classList.contains('pet-img')) {
        e.target.classList.remove("react"); void e.target.offsetWidth; e.target.classList.add("react");
        pet.stats.xp = (pet.stats.xp || 0) + 5;
        spawnPop(reactMap[pet.species] || "ğŸ’•", e.clientX, e.clientY);
        checkGrowth(); save();
      }
    }

    function feedPet(e) { 
      e.stopPropagation(); 
      if(!pet || isSleeping || pet.stats.health <= 0) return; 
      pet.stats.hunger = Math.max(0, pet.stats.hunger - 20); 
      // Drop food from top
      const food = document.createElement("div");
      food.className = "food-drop";
      food.innerText = foodMap[pet.species];
      food.style.left = "50%";
      document.body.appendChild(food);
      setTimeout(() => food.remove(), 1500);
      save(); 
    }

    function cleanPet(e) { e.stopPropagation(); if(!pet || isSleeping || pet.stats.health <= 0) return; pet.stats.health = Math.min(100, pet.stats.health + 10); spawnPop("ğŸ«§", window.innerWidth/2, window.innerHeight/2); save(); }
    function playPet(e) { e.stopPropagation(); if(!pet || isSleeping || pet.stats.health <= 0) return; pet.stats.energy = Math.max(0, pet.stats.energy - 15); spawnPop("âš½ï¸", window.innerWidth/2, window.innerHeight/2); save(); }
    function doctorPet(e) { e.stopPropagation(); if(!pet || isSleeping || pet.stats.health <= 0) return; pet.stats.health = Math.min(100, pet.stats.health + 40); save(); }
    function resurrectPet(e) { e.stopPropagation(); pet.stats = { hunger: 50, energy: 50, health: 100, level: 1, xp: 0 }; display(pet); save(); }
    function toggleSleep(e) { e.stopPropagation(); isSleeping = !isSleeping; document.body.style.filter = isSleeping ? "brightness(0.4)" : "none"; save(); }

    function toggleMenu(e) { e.stopPropagation(); const m = document.getElementById('createMenu'); m.style.display = m.style.display === 'block' ? 'none' : 'block'; }
    function spawnPop(txt, x, y) {
      const p = document.createElement("div"); p.className = "pop"; p.innerText = txt;
      p.style.left = x + "px"; p.style.top = y + "px";
      document.body.appendChild(p); setTimeout(() => p.remove(), 1200);
    }
    function updateUI() {
      if (!pet) return;
      const s = pet.stats;
      document.getElementById("sn").innerHTML = `<b>${s.health <= 0 ? 'ğŸ‘»' : ''} ${pet.name} (Lv.${s.level})</b>`;
      document.getElementById("sh").innerText = `Hunger: ${Math.round(s.hunger)}%`;
      document.getElementById("se").innerText = `Energy: ${Math.round(s.energy)}%`;
      document.getElementById("shp").innerText = `Health: ${Math.round(s.health)}%`;
      document.getElementById("sl").innerText = `XP: ${s.xp}/100`;
    }
    async function save() { await db.collection("pets").doc(pet.id).update({ stats: pet.stats, lastUpdated: Date.now() }); updateUI(); }
    function checkGrowth() { if (pet.stats.xp >= 100) { pet.stats.level++; pet.stats.xp = 0; display(pet); } }
    
    async function createPet() {
      const n = document.getElementById("petName").value;
      const s = document.getElementById("petSpecies").value;
      if (!n) return;
      const res = await db.collection("pets").add({ name: n, species: s, lastUpdated: Date.now(), stats: { hunger: 50, energy: 50, health: 100, level: 1, xp: 0 } });
      display({ id: res.id, name: n, species: s, stats: { hunger: 50, energy: 50, health: 100, level: 1, xp: 0 } });
      document.getElementById('createMenu').style.display = 'none';
    }

    async function fetchPet() {
      const snap = await db.collection("pets").orderBy("lastUpdated", "desc").limit(1).get();
      if (!snap.empty) display({ id: snap.docs[0].id, ...snap.docs[0].data() });
    }
    fetchPet();
  </script>
</body>
</html>
