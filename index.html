<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#1a1a1a">

<title>Luna & Stella Pets</title>

<link rel="manifest" href="manifest.json">

<link rel="icon" type="image/jpeg" href="bg_wp.JPG">

<link rel="apple-touch-icon" href="bg_wp.JPG">

<style>
:root { 
  --glass: rgba(0, 0, 0, 0.85); 
  --gold: #ffcc00;
  --safe-top: env(safe-area-inset-top, 44px); 
  --safe-bottom: env(safe-area-inset-bottom, 34px);
}

* { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }

body {
  /* 1. Layout & Anti-Slide */
  margin: 0; 
  padding: 0; 
  width: 100vw; 
  height: 100dvh; 
  overflow: hidden; 
  position: fixed; 
  
  /* 2. Visuals */
  font-family: -apple-system, sans-serif;
  background: #1a1a1a url('bg_wp.jpg') no-repeat center center fixed;
  background-size: cover; 
  color: #fff; 
  transition: filter 2s;

  /* 3. Anti-Zoom & Touch Logic (The Fixes) */
  -webkit-text-size-adjust: 100%; /* Stops text from resizing on tilt */
  -webkit-user-select: none;      /* Stops text highlighting when tapping fast */
  touch-action: none;             /* Tells Safari: "I'll handle the touches, don't zoom" */
}


body.is-stormy { filter: brightness(0.7) contrast(1.1) saturate(0.9); }

#night-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0, 5, 40, 0.7); pointer-events: none;
  opacity: 0; transition: opacity 1.5s; z-index: 999;
}

.flash-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; pointer-events: none; z-index: 10001; }
.do-flash { animation: lightningStrike 0.15s ease-out; }
@keyframes lightningStrike { 0% { opacity: 1; } 100% { opacity: 0; } }

#weather-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }
.rain-drop { position: absolute; background: #4fa1ff; width: 2px; height: 15px; opacity: 0.5; animation: rainFall 0.8s linear infinite; }
@keyframes rainFall { 0% { transform: translateY(-100px); } 100% { transform: translateY(110vh); } }

/* UI BOXES */
#hud-container { 
  position: absolute; top: var(--safe-top); left: 50%; transform: translateX(-50%);
  display: flex; flex-direction: column; align-items: center; width: 100%; z-index: 10000; pointer-events: none;
}

.hud-bar { 
  pointer-events: auto; background: var(--glass); padding: 8px 18px; border-radius: 40px; 
  backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.15); display: flex; align-items: center; gap: 12px;
}

#statsBox { display: flex; gap: 10px; font-size: 12px; font-weight: 700; }

/* THE MENU FIX */
#createMenu {
  pointer-events: auto; 
  display: none; 
  background: var(--glass); 
  border-radius: 20px; 
  width: 300px; 
  height: 380px; /* FIXED HEIGHT */
  position: absolute;
  top: 80px;
  display: flex;
  flex-direction: column; /* FORCES INTERNAL SCROLLING */
  border: 1px solid var(--gold); 
  overflow: hidden; 
}

.menu-tabs { display:flex; background:rgba(255,255,255,0.1); flex-shrink: 0; }
.tab-btn { flex:1; padding:12px; color:white; background:none; border:none; font-weight:bold; font-size: 11px; cursor: pointer; }

/* THE SCROLLABLE AREAS */
#mypetsTab, #hofTab, #helpTab, #adoptTab {
  flex: 1; 
  overflow-y: auto !important; 
  -webkit-overflow-scrolling: touch; 
  padding: 15px;
}

.pet-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(255,255,255,0.1);
  margin-bottom: 8px;
  padding: 12px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.1);
}

.delete-btn { background: #ff4444; color: white; border: none; border-radius: 8px; padding: 6px 10px; font-size: 14px; }

/* PET & ACTION BAR */
#game-world { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 50; text-align: center; }
.pet-img { filter: drop-shadow(0 0 10px rgba(255,255,255,0.3)); width: 130px; transition: transform 0.2s; }
.wander { animation: wander 14s linear infinite alternate; }
@keyframes wander { 0% { transform: translate(-60px, 0); } 100% { transform: translate(60px, 0); } }

.action-bar { 
  position: absolute; bottom: calc(var(--safe-bottom) + 15px); left: 50%; transform: translateX(-50%);
  display: flex; gap: 12px; z-index: 10000; background: rgba(0,0,0,0.85); padding: 12px 20px; 
  border-radius: 40px; backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.2);
}

.action-bar button { 
  background: #222; 
  border: 1px solid #444; 
  color: white; 
  border-radius: 50%; 
  width: 54px; 
  height: 54px; 
  font-size: 26px;
  /* Add these two lines below */
  touch-action: manipulation; 
  user-select: none;
}


.pop { position: absolute; font-size: 35px; animation: popUp 1.2s forwards; z-index: 10005; pointer-events: none; left: 50%; transform: translateX(-50%); }
@keyframes popUp { 0% { opacity: 1; top: 50%; } 100% { opacity: 0; top: 40%; } }

.food-drop { position: absolute; font-size: 45px; z-index: 60; animation: fall 1s ease-in forwards; left: 50%; margin-left: -22px; top: 30%; }
@keyframes fall { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(150px); opacity: 0; } }

select, input { width: 100%; background: #333; color: white; border: 1px solid #555; padding: 12px; border-radius: 8px; margin-bottom: 10px; font-size: 16px; }
</style>
</head>
<body onclick="handlePetting(event)">

<div id="night-overlay"></div>
<div id="flash-layer" class="flash-overlay"></div>
<div id="weather-layer"></div>

<div id="hud-container">
  <div class="hud-bar">
    <button style="background:none; border:none; font-size:20px; color:white; cursor:pointer;" onclick="toggleMenu(event)">âš™ï¸</button>
    <div id="statsBox">
      <div id="sn"><b>Loading...</b></div>
      <div id="sh">H:â€”</div><div id="se">E:â€”</div><div id="shp">HP:â€”</div>
    </div>
  </div>

  <div id="createMenu">
    <div class="menu-tabs">
      <button onclick="switchTab('help')" class="tab-btn">Manual</button>
      <button onclick="switchTab('hof')" class="tab-btn">Legends</button>
      <button onclick="switchTab('adopt')" class="tab-btn">Adopt</button>
      <button onclick="switchTab('mypets')" class="tab-btn">My Pets</button>
    </div>
    
    <div id="helpTab" style="text-align:center;">
      ğŸ Hunger | ğŸŒ™ Energy | ğŸ§½ Health | âš½ XP
      <p style="font-size:11px; margin-top:10px;">Pet the species to earn XP!</p>
    </div>
    
    <div id="hofTab" style="display:none;"><div id="hofList">Loading...</div></div>
    
    <div id="adoptTab" style="display:none; text-align:center;">
      <input id="petName" placeholder="Pet Name">
      <select id="petSpecies">
  <option value="dog">Dog ğŸ•</option>
  <option value="cat">Cat ğŸ±</option>
  <option value="dragon">Dragon ğŸ²</option>
  <option value="bunny">Bunny ğŸ°</option>
  <option value="fox">Fox ğŸ¦Š</option>
  <option value="unicorn">Unicorn ğŸ¦„</option>
  <option value="frog">Frog ğŸ¸</option> </select>

      <button onclick="createPet()" style="background:var(--gold); border:none; padding:12px; width:100%; border-radius:8px; font-weight:bold;">ADOPT</button>
    </div>
    
    <div id="mypetsTab" style="display:none;"><div id="myPetsList"></div></div>
  </div>

  <div class="audio-controls" style="display:flex; gap:15px; margin-top:10px; pointer-events:auto; background:rgba(0,0,0,0.3); padding:5px 15px; border-radius:20px;">
    <button onclick="setVol(0, event)" style="background:none; border:none; cursor:pointer;">ğŸ”ˆ</button>
    <button onclick="setVol(0.4, event)" style="background:none; border:none; cursor:pointer;">ğŸ”‰</button>
    <button onclick="setVol(0.8, event)" style="background:none; border:none; cursor:pointer;">ğŸ”Š</button>
  </div>
</div>

<div id="game-world"></div>

<div class="action-bar">
  <button onclick="feedPet(event)">ğŸ</button>
  <button onclick="cleanPet(event)">ğŸ§½</button>
  <button onclick="playPet(event)">âš½ï¸</button>
  <button onclick="doctorPet(event)">ğŸ©º</button>
  <button onclick="toggleSleep(event)">ğŸŒ™</button>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = { apiKey:"AIzaSyDkpW7RAmX0wPmL757_GzEFIoU6snssLnA", authDomain:"pets-86c25.firebaseapp.com", projectId:"pets-86c25", storageBucket:"pets-86c25.firebasestorage.app", messagingSenderId:"556129222317", appId:"1:556129222d59024" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let pet = null, isSleeping = false, isRaining = false;
let audioCtx, gainNode, musicSource;
// Added Frog and Flies!
const foodMap = { bunny:"ğŸ¥•", fox:"ğŸ”", dog:"ğŸ¥©", dragon:"ğŸ–", cat:"ğŸ ", unicorn:"ğŸ", frog:"ğŸª°" };
const emojiMap = { bunny:"ğŸ°", fox:"ğŸ¦Š", dog:"ğŸ•", dragon:"ğŸ²", cat:"ğŸ±", unicorn:"ğŸ¦„", frog:"ğŸ¸" };

// --- AUDIO SYSTEM (RE-FIXED) ---
async function initAudio() {
  if (audioCtx) {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    return;
  }
  
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  gainNode = audioCtx.createGain();
  gainNode.connect(audioCtx.destination);
  
  try {
    const res = await fetch('happy-day.mp3');
    const ab = await res.arrayBuffer();
    const buffer = await audioCtx.decodeAudioData(ab);
    
    musicSource = audioCtx.createBufferSource();
    musicSource.buffer = buffer;
    musicSource.loop = true;
    musicSource.connect(gainNode);
    musicSource.start(0);
    gainNode.gain.setValueAtTime(0.4, audioCtx.currentTime);
  } catch (e) {
    console.log("Audio failed to load:", e);
  }
}

function setVol(val, e) {
  if(e) e.stopPropagation();
  initAudio(); // Initialize on first click
  if (gainNode) {
    gainNode.gain.setTargetAtTime(val, audioCtx.currentTime, 0.2);
  }
}

// --- ENGINE ---
function gameHeartbeat() {
  if (!pet) return;
  const world = document.getElementById("game-world");
  if (pet.stats.health <= 0) {
    pet.stats.health = 0;
    world.classList.remove("wander");
    world.innerHTML = `<div style="font-size:80px; filter:grayscale(1) opacity(0.7);">ğŸ‘»</div><div>RIP ${pet.name}</div>`;
    updateUI(); return;
  }
  if (isSleeping) { 
    pet.stats.energy = Math.min(100, pet.stats.energy + 10); 
    spawnPop("ğŸ’¤"); 
  } else { 
    pet.stats.hunger = Math.min(100, pet.stats.hunger + 2); 
    pet.stats.energy = Math.max(0, pet.stats.energy - 1); 
    if (pet.stats.hunger > 90 || pet.stats.energy <= 0) pet.stats.health -= 3; 
  }
  updateUI(); save();
}
setInterval(gameHeartbeat, 5000);

// --- TABS & SCROLLING ---
function switchTab(t) {
  ['helpTab','hofTab','adoptTab','mypetsTab'].forEach(id => document.getElementById(id).style.display = 'none');
  const target = document.getElementById(t + 'Tab');
  target.style.display = 'block';
  if(t === 'mypets') fetchMyPets();
  if(t === 'hof') fetchHOF();
}

async function fetchMyPets() {
  const snap = await db.collection("pets").orderBy("lastUpdated", "desc").get();
  const list = document.getElementById('myPetsList');
  list.innerHTML = snap.docs.map(doc => {
    const p = doc.data();
    return `<div class="pet-row">
        <div onclick="loadPet('${doc.id}')" style="flex:1;">
          ${p.stats.health <= 0 ? 'ğŸ‘»' : (emojiMap[p.species] || 'ğŸ¾')} <b>${p.name}</b> <small>Lv.${p.stats.level}</small>
        </div>
        <button class="delete-btn" onclick="deletePet('${doc.id}', '${p.name}', event)">ğŸ—‘ï¸</button>
      </div>`;
  }).join('');
}

async function loadPet(id) {
  const doc = await db.collection("pets").doc(id).get();
  if(doc.exists) { 
    isSleeping = false; 
    document.getElementById('night-overlay').style.opacity = "0";
    display({id: doc.id, ...doc.data()}); 
    document.getElementById('createMenu').style.display = 'none';
    initAudio(); // Resume music if user interacts
  }
}

async function deletePet(id, name, e) {
  e.stopPropagation();
  if (confirm(`Delete ${name}?`)) {
    await db.collection("pets").doc(id).delete();
    if (pet && pet.id === id) { pet = null; document.getElementById("game-world").innerHTML = ""; }
    fetchMyPets();
  }
}

async function fetchHOF() {
  const snap = await db.collection("pets").orderBy("stats.level", "desc").limit(10).get();
  document.getElementById('hofList').innerHTML = snap.docs.map(d => `<div class="pet-row"><span>${d.data().name}</span><b>Lv.${d.data().stats.level}</b></div>`).join('');
}

// --- ACTIONS ---
function feedPet(e) { e.stopPropagation(); initAudio(); if(!pet || isSleeping || pet.stats.health <= 0) return; pet.stats.hunger = Math.max(0, pet.stats.hunger - 25); const f = document.createElement("div"); f.className = "food-drop"; f.innerText = foodMap[pet.species] || "ğŸ¥©"; document.body.appendChild(f); setTimeout(()=>f.remove(), 1000); updateUI(); save(); }
function cleanPet(e) { e.stopPropagation(); if(!pet || pet.stats.health <= 0) return; pet.stats.health = Math.min(100, pet.stats.health + 15); spawnPop("ğŸ«§"); updateUI(); save(); }
function playPet(e) { e.stopPropagation(); if(!pet || isSleeping || pet.stats.health <= 0) return; if(pet.stats.energy < 15) { spawnPop("ğŸ’¤"); return; } pet.stats.energy -= 15; pet.stats.xp += 20; if(pet.stats.xp >= 100) { pet.stats.level++; pet.stats.xp = 0; spawnPop("ğŸ†™"); display(pet); } spawnPop("âš½ï¸"); updateUI(); save(); }
function doctorPet(e) { e.stopPropagation(); if(!pet) return; if(pet.stats.health <= 0) { pet.stats.health = 50; display(pet); spawnPop("ğŸ’–"); } else { pet.stats.health = Math.min(100, pet.stats.health + 30); spawnPop("ğŸ©º"); } updateUI(); save(); }

function toggleSleep(e) { 
  e.stopPropagation(); 
  if(!pet || pet.stats.health <= 0) return; 
  isSleeping = !isSleeping; 
  document.getElementById('night-overlay').style.opacity = isSleeping ? "1" : "0"; 
  if (gainNode) { 
    const v = isSleeping ? 0.05 : 0.4; // Night is very quiet
    gainNode.gain.setTargetAtTime(v, audioCtx.currentTime, 1.5); 
  } 
  spawnPop(isSleeping ? "ğŸŒ–" : "â˜€ï¸"); 
}

// --- SYSTEM ---
function display(data){
  pet = data; const world = document.getElementById("game-world");
  world.classList.toggle("wander", pet.stats.health > 0 && !isSleeping);
  if(pet.stats.health <= 0) world.innerHTML = `<div style="font-size:80px;">ğŸ‘»</div><div>RIP ${pet.name}</div>`;
  else world.innerHTML = `<img src="${pet.species}.png" class="pet-img" style="width:${100+(pet.stats.level*5)}px">`;
  updateUI();
}
function updateUI(){ if(!pet) return; const s=pet.stats; document.getElementById("sn").innerHTML=`<b>${pet.name}</b>`; document.getElementById("sh").innerText=`H:${Math.round(s.hunger)}%`; document.getElementById("se").innerText=`E:${Math.round(s.energy)}%`; document.getElementById("shp").innerText=`HP:${Math.round(s.health)}%`; }
async function save(){ if(pet?.id) await db.collection("pets").doc(pet.id).update({stats:pet.stats, lastUpdated:Date.now()}); }
function toggleMenu(e){ e.stopPropagation(); const m = document.getElementById('createMenu'); m.style.display = (m.style.display==='flex')?'none':'flex'; }

async function createPet(){
  const n=document.getElementById("petName").value; const s=document.getElementById("petSpecies").value; if(!n) return;
  const res = await db.collection("pets").add({name:n,species:s,lastUpdated:Date.now(),stats:{hunger:50,energy:50,health:100,level:1,xp:0}});
  display({id:res.id,name:n,species:s,stats:{hunger:50,energy:50,health:100,level:1,xp:0}});
  document.getElementById('createMenu').style.display='none';
}
function spawnPop(t){ const p=document.createElement("div"); p.className="pop"; p.innerText=t; document.body.appendChild(p); setTimeout(()=>p.remove(),1200); }
function handlePetting(e){ if(!pet || isSleeping || pet.stats.health <= 0) return; if(e.target.classList.contains('pet-img')){ pet.stats.xp += 10; spawnPop("ğŸ’•"); save(); }}

// --- WEATHER ---
function toggleWeather() {
  const layer = document.getElementById('weather-layer');
  isRaining = Math.random() < 0.3; layer.innerHTML = '';
  if(isRaining) {
    document.body.classList.add('is-stormy');
    for(let i=0; i<35; i++){
      const d = document.createElement('div'); d.className = 'rain-drop'; d.style.left = Math.random()*100+'%'; d.style.animationDelay = Math.random()*2+'s';
      layer.appendChild(d);
    }
    triggerLightning();
  } else { document.body.classList.remove('is-stormy'); }
}
function triggerLightning() {
  if(!isRaining) return; const fl = document.getElementById('flash-layer'); fl.classList.add('do-flash');
  setTimeout(() => fl.classList.remove('do-flash'), 150); setTimeout(triggerLightning, Math.random()*8000+4000);
}
setInterval(toggleWeather, 40000);

// Start
db.collection("pets").orderBy("lastUpdated","desc").limit(1).get().then(s=>{if(!s.empty) display({id:s.docs[0].id,...s.docs[0].data()});});
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js')
    .then(() => console.log("Service Worker Registered"))
    .catch((err) => console.log("Service Worker Failed", err));
}

</script>

</body>
</html>
