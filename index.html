<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Reality Pets: Life & Death</title>
  <style>
    :root { --glass: rgba(0, 0, 0, 0.85); --gold: #ffcc00; --danger: #ff3b30; }
    
    body {
      margin: 0; font-family: -apple-system, sans-serif;
      background: #1a1a1a url('bg_wp.jpg') no-repeat center center fixed;
      background-size: cover; color: #fff; overflow: hidden; height: 100vh;
      transition: filter 0.5s;
    }

    /* Minimal Stats */
    .stats-mini {
      position: absolute; top: env(safe-area-inset-top, 20px); right: 10px;
      background: var(--glass); padding: 8px 12px; border-radius: 15px;
      font-size: 11px; z-index: 100; backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
    }

    .menu-wrap { position: absolute; top: env(safe-area-inset-top, 20px); left: 10px; z-index: 101; }
    #createMenu {
      display: none; background: var(--glass); padding: 12px; 
      border-radius: 15px; margin-top: 8px; width: 150px;
    }
    
    .gear-btn { background: var(--glass); border: none; font-size: 20px; border-radius: 50%; padding: 6px 10px; color: white; }

    /* Action Bar */
    .action-bar {
      position: absolute; bottom: env(safe-area-inset-bottom, 25px);
      left: 50%; transform: translateX(-50%);
      display: flex; gap: 10px; z-index: 100;
      background: rgba(255,255,255,0.1); padding: 8px; border-radius: 20px;
      backdrop-filter: blur(15px);
    }
    .action-bar button {
      background: var(--glass); border: 1px solid rgba(255,255,255,0.2);
      color: white; border-radius: 50%; width: 45px; height: 45px; font-size: 20px;
      display: flex; align-items: center; justify-content: center;
    }

    /* Pet Logic */
    .pet-stage { position: absolute; left: 50%; bottom: 30%; transform: translateX(-50%); transition: all 0.6s ease; }
    .pet-img { filter: drop-shadow(0 0 15px rgba(255,255,255,0.3)); animation: float 3s ease-in-out infinite; cursor: pointer; }
    
    /* Ghost Style */
    .is-ghost { filter: grayscale(1) opacity(0.5) drop-shadow(0 0 20px cyan) !important; animation: ghostFloat 4s ease-in-out infinite !important; }

    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
    @keyframes ghostFloat { 0%, 100% { transform: translateY(0) rotate(5deg); } 50% { transform: translateY(-30px) rotate(-5deg); } }

    .pop { position: absolute; font-size: 32px; animation: popUp 1.2s forwards; pointer-events: none; z-index: 200; text-shadow: 0 0 10px black; }
    @keyframes popUp { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: translateY(-120px) scale(1.2); opacity: 0; } }
  </style>
</head>
<body onclick="handlePetting(event)">

  <div class="menu-wrap">
    <button class="gear-btn" onclick="toggleMenu(event)">‚öôÔ∏è</button>
    <div id="createMenu">
      <input id="petName" placeholder="Pet Name" style="width:100%; margin-bottom:8px; border-radius:5px; border:none; padding:5px;">
      <select id="petSpecies" style="width:100%; margin-bottom:8px; border-radius:5px; padding:5px;">
        <option value="bunny">Bunny</option>
        <option value="fox">Fox</option>
        <option value="dog">Dog</option>
        <option value="dragon">Dragon</option>
        <option value="cat">Cat</option>
        <option value="unicorn">Unicorn</option>
        <option value="frog">Frog</option>
      </select>
      <button onclick="createPet()" style="width:100%; background:var(--gold); border:none; border-radius:8px; padding:8px; font-weight:bold;">ADOPT</button>
    </div>
  </div>

  <div class="stats-mini" id="statsBox">
    <div id="sn"><b>Adopt a Pet!</b></div>
    <div id="sh">Hunger: ‚Äî</div>
    <div id="se">Energy: ‚Äî</div>
    <div id="shp">Health: ‚Äî</div>
    <div id="sl">Level: ‚Äî</div>
  </div>

  <div id="game-world" class="pet-stage"></div>

  <div class="action-bar">
    <button onclick="feedPet()">üçé</button>
    <button onclick="cleanPet()">üßΩ</button>
    <button onclick="playPet()">‚öΩÔ∏è</button>
    <button onclick="doctorPet()">ü©∫</button>
    <button id="resBtn" onclick="resurrectPet()" style="display:none; background:var(--gold);">‚ö°Ô∏è</button>
    <button id="sleepBtn" onclick="toggleSleep()">üåô</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDkpW7RAmX0wPmL757_GzEFIoU6snssLnA",
      authDomain: "pets-86c25.firebaseapp.com",
      projectId: "pets-86c25",
      storageBucket: "pets-86c25.firebasestorage.app",
      messagingSenderId: "556129222317",
      appId: "1:556129222317:web:12d323a5165eb222d59024"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let pet = null;
    let isSleeping = false;
    const foodMap = { bunny:"ü•ï", fox:"üçî", dog:"ü•©", dragon:"üçñ", cat:"üê†", unicorn:"üçé", frog:"ü™∞" };

    function toggleMenu(e) { e.stopPropagation(); const m = document.getElementById('createMenu'); m.style.display = m.style.display === 'block' ? 'none' : 'block'; }
    
    function handlePetting(e) {
      if (!pet || isSleeping || pet.stats.health <= 0) return;
      if (e.target.classList.contains('pet-img')) {
        pet.stats.xp = (pet.stats.xp || 0) + 5;
        spawnEffect("üíï", e.clientX, e.clientY);
        checkGrowth();
        save();
      }
    }

    async function fetchPet() {
      const snap = await db.collection("pets").orderBy("lastUpdated", "desc").limit(1).get();
      if (!snap.empty) display({ id: snap.docs[0].id, ...snap.docs[0].data() });
    }

    function display(data) {
      pet = data;
      const world = document.getElementById("game-world");
      const isDead = pet.stats.health <= 0;
      const size = 100 + (pet.stats.level * 10);
      
      world.innerHTML = `<img src="${pet.species}.png" class="pet-img ${isDead ? 'is-ghost' : ''}" style="width:${size}px">`;
      document.getElementById("resBtn").style.display = isDead ? "flex" : "none";
      updateUI();
    }

    function updateUI() {
      if (!pet) return;
      const s = pet.stats;
      document.getElementById("sn").innerHTML = `<b>${s.health <= 0 ? 'üëª' : ''} ${pet.name} (Lv.${s.level})</b>`;
      document.getElementById("sh").innerText = `Hunger: ${Math.round(s.hunger)}%`;
      document.getElementById("se").innerText = `Energy: ${Math.round(s.energy)}%`;
      document.getElementById("shp").innerText = `Health: ${Math.round(s.health)}%`;
      document.getElementById("sl").innerText = `XP: ${s.xp}/100`;
      
      if(s.health <= 0) document.body.style.filter = "grayscale(0.8) contrast(1.2)";
      else if(!isSleeping) document.body.style.filter = "none";
    }

    // Actions
    function feedPet() { if(!pet || isSleeping || pet.stats.health <= 0) return; pet.stats.hunger = Math.max(0, pet.stats.hunger - 20); pet.stats.xp += 2; spawnEffect(foodMap[pet.species], 150, 400); checkDeath(); save(); }
    function cleanPet() { if(!pet || isSleeping || pet.stats.health <= 0) return; pet.stats.health = Math.min(100, pet.stats.health + 10); spawnEffect("ü´ß", 150, 400); save(); }
    function playPet() { if(!pet || isSleeping || pet.stats.health <= 0) return; pet.stats.energy = Math.max(0, pet.stats.energy - 15); pet.stats.xp += 10; spawnEffect("‚öΩÔ∏è", 150, 400); checkDeath(); save(); }
    function doctorPet() { if(!pet || isSleeping || pet.stats.health <= 0) return; pet.stats.health = Math.min(100, pet.stats.health + 40); pet.stats.energy = Math.max(0, pet.stats.energy - 20); spawnEffect("ü©∫", 150, 400); save(); }

    function resurrectPet() {
      if(!pet || pet.stats.health > 0) return;
      pet.stats = { hunger: 50, energy: 50, health: 100, level: 1, xp: 0 };
      spawnEffect("‚ö°Ô∏è‚ú®", window.innerWidth/2, window.innerHeight/2);
      display(pet);
      save();
    }

    function checkDeath() {
      // Natural health decay if hunger is 100 or energy is 0
      if (pet.stats.hunger >= 100 || pet.stats.energy <= 0) {
        pet.stats.health = Math.max(0, pet.stats.health - 10);
      }
      if (pet.stats.health <= 0) display(pet);
    }

    function checkGrowth() {
      if (pet.stats.xp >= 100) {
        pet.stats.level++; pet.stats.xp = 0;
        spawnEffect("‚¨ÜÔ∏è LEVEL UP!", window.innerWidth/2, window.innerHeight/2);
        display(pet);
      }
    }

    function toggleSleep() {
      if(!pet || pet.stats.health <= 0) return;
      isSleeping = !isSleeping;
      document.body.style.filter = isSleeping ? "brightness(0.3) hue-rotate(200deg)" : "none";
      if(isSleeping) {
        pet.stats.energy = Math.min(100, pet.stats.energy + 30);
        spawnEffect("üí§", 150, 400);
      }
      save();
    }

    async function save() {
      await db.collection("pets").doc(pet.id).update({ stats: pet.stats, lastUpdated: Date.now() });
      updateUI();
    }

    function spawnEffect(txt, x, y) {
      const p = document.createElement("div"); p.className = "pop"; p.innerText = txt;
      p.style.left = x + "px"; p.style.top = y + "px";
      document.body.appendChild(p); setTimeout(() => p.remove(), 1200);
    }

    async function createPet() {
      const n = document.getElementById("petName").value;
      const s = document.getElementById("petSpecies").value;
      if (!n) return;
      const res = await db.collection("pets").add({
        name: n, species: s, lastUpdated: Date.now(),
        stats: { hunger: 50, energy: 50, health: 100, level: 1, xp: 0 }
      });
      display({ id: res.id, name: n, species: s, stats: { hunger: 50, energy: 50, health: 100, level: 1, xp: 0 } });
      toggleMenu({stopPropagation:()=>{}});
    }

    fetchPet();
  </script>
</body>
</html>
