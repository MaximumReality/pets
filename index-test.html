<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Reality Pets: Stormy Wind</title>
<style>
:root { 
  --glass: rgba(0, 0, 0, 0.85); 
  --gold: #ffcc00;
  --safe-top: env(safe-area-inset-top, 44px); 
  --safe-bottom: env(safe-area-inset-bottom, 34px);
}

body {
  margin: 0; padding: 0;
  font-family: -apple-system, sans-serif;
  background: #1a1a1a url('bg_wp.jpg') no-repeat center center fixed;
  background-size: cover;
  color: #fff; 
  height: 100dvh; /* Dynamic height for Safari */
  width: 100vw;
  overflow: hidden;
  position: fixed;
  touch-action: manipulation;
}

/* TOP HUD - Back to the way you liked it */
#hud-container { 
  position: absolute;
  top: var(--safe-top);
  left: 50%;
  transform: translateX(-50%);
  display: flex; 
  flex-direction: column; 
  align-items: center; 
  gap: 10px; 
  width: 90%;
  z-index: 10000;
}

.hud-bar { 
  background: var(--glass); 
  padding: 8px 15px; 
  border-radius: 25px; 
  backdrop-filter: blur(15px); 
  border: 1px solid rgba(255,255,255,0.15); 
  display: flex; 
  align-items: center; 
  gap: 15px;
}

/* MENU FIX: No more yellow line! */
#createMenu {
  display: none; 
  background: var(--glass); 
  border-radius: 20px; 
  width: 280px; 
  min-height: 100px; /* Prevents the line effect */
  box-shadow: 0 10px 40px rgba(0,0,0,0.9); 
  border: 1px solid var(--gold);
  z-index: 10002; 
  overflow: hidden; 
  margin-top: 10px;
}

/* BOTTOM BAR - Floating comfortably above Safari */
.action-bar { 
  position: absolute;
  bottom: calc(var(--safe-bottom) + 15px);
  left: 50%;
  transform: translateX(-50%);
  display: flex; 
  gap: 12px; 
  z-index: 10000;
  background: rgba(0,0,0,0.8); 
  padding: 12px 18px; 
  border-radius: 35px; 
  backdrop-filter: blur(20px); 
  border: 1px solid rgba(255,255,255,0.1);
}

.action-bar button { 
  background: #222; border: 1px solid #444; color: white; 
  border-radius: 50%; width: 54px; height: 54px; font-size: 26px; 
}

/* PET - Centered but out of the way of the bars */
#game-world { 
  position: absolute; 
  top: 52%; left: 50%; 
  transform: translate(-50%, -50%); 
  z-index: 50; 
  text-align: center;
}

.pet-img { filter: drop-shadow(0 0 10px rgba(255,255,255,0.3)); cursor: pointer; }
.wander { animation: wander 14s linear infinite alternate; }
@keyframes wander { 0% { transform: translate(-60px, 0); } 100% { transform: translate(60px, 0); } }
</style>

<body onclick="handlePetting(event)">
  <div id="night-overlay"></div>
  <div id="flash-layer" class="flash-overlay"></div>
  <div id="weather-layer"></div>

  <div id="hud-container">
    <div class="hud-bar">
      <button style="background:none; border:none; font-size:20px;" onclick="toggleMenu(event)">âš™ï¸</button>
      <div id="statsBox">
        <div id="sn"><b>Casper</b></div>
        <div id="sh">H:â€”</div><div id="se">E:â€”</div><div id="shp">HP:â€”</div>
      </div>
    </div>

    <div id="createMenu">
      <div class="menu-tabs" style="display:flex; background:rgba(255,255,255,0.1);">
        <button class="tab-btn active" onclick="switchTab('help')" style="flex:1; padding:10px; color:white; background:none; border:none;">Manual</button>
        <button class="tab-btn" onclick="switchTab('hof')" style="flex:1; padding:10px; color:white; background:none; border:none;">Legends</button>
        <button class="tab-btn" onclick="switchTab('adopt')" style="flex:1; padding:10px; color:white; background:none; border:none;">Adopt</button>
      </div>
      <div id="helpTab" class="menu-content" style="padding:15px; font-size:12px;">
        <p><b>H:</b> Hunger (Drop Food ğŸ)<br><b>E:</b> Energy (Sleep ğŸŒ™)<br><b>HP:</b> Health (Clean ğŸ§½ / Med ğŸ©º)</p>
      </div>
      <div id="hofTab" class="menu-content" style="display:none; padding:15px;"><div id="hofList">Loading...</div></div>
      <div id="adoptTab" class="menu-content" style="display:none; padding:15px;">
        <input id="petName" placeholder="Name" style="width:90%; background:#333; color:white; border:none; padding:8px; border-radius:5px; margin-bottom:5px;">
        <button onclick="createPet()" style="width:100%; background:var(--gold); border:none; padding:10px; font-weight:bold; border-radius:5px;">ADOPT</button>
      </div>
    </div>

    <div class="audio-controls" style="display:flex; gap:10px; background:rgba(0,0,0,0.4); padding:5px 15px; border-radius:15px;">
      <button onclick="setVol(0, event)" style="background:none; border:none; color:white;">ğŸ”ˆ</button>
      <button onclick="setVol(0.3, event)" style="background:none; border:none; color:white;">ğŸ”‰</button>
      <button onclick="setVol(0.7, event)" style="background:none; border:none; color:white;">ğŸ”Š</button>
    </div>
  </div>

  <div id="game-world"></div>

  <div class="action-bar">
    <button onclick="feedPet(event)">ğŸ</button>
    <button onclick="cleanPet(event)">ğŸ§½</button>
    <button onclick="playPet(event)">âš½ï¸</button>
    <button onclick="doctorPet(event)">ğŸ©º</button>
    <button onclick="toggleSleep(event)">ğŸŒ™</button>
  </div>

  </div>


<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = { apiKey:"AIzaSyDkpW7RAmX0wPmL757_GzEFIoU6snssLnA", authDomain:"pets-86c25.firebaseapp.com", projectId:"pets-86c25", storageBucket:"pets-86c25.firebasestorage.app", messagingSenderId:"556129222317", appId:"1:556129222d59024" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let pet = null, isSleeping = false, isRaining = false;
let audioCtx, gainNode, musicSource;
const foodMap = { bunny:"ğŸ¥•", fox:"ğŸ”", dog:"ğŸ¥©", dragon:"ğŸ–", cat:"ğŸ ", unicorn:"ğŸ", frog:"ğŸª°" };
const emojiMap = { bunny:"ğŸ°", fox:"ğŸ¦Š", dog:"ğŸ•", dragon:"ğŸ²", cat:"ğŸ±", unicorn:"ğŸ¦„", frog:"ğŸ¸" };

// --- ACTIONS ---
function feedPet(e) {
  e.stopPropagation(); if(!pet || isSleeping || pet.stats.health <= 0) return;
  pet.stats.hunger = Math.max(0, pet.stats.hunger - 25);
  const f = document.createElement("div"); f.className = "food-drop"; f.innerText = foodMap[pet.species] || "ğŸ";
  f.style.left = "50%"; document.body.appendChild(f); setTimeout(()=>f.remove(), 1200);
  updateUI(); save();
}

function cleanPet(e) {
  e.stopPropagation(); if(!pet || pet.stats.health <= 0) return;
  pet.stats.health = Math.min(100, pet.stats.health + 10);
  document.getElementById('messes').innerHTML = '';
  spawnPop("ğŸ«§", window.innerWidth/2, window.innerHeight/2);
  updateUI(); save();
}

function playPet(e) {
  e.stopPropagation(); if(!pet || isSleeping || pet.stats.health <= 0) return;
  if(pet.stats.energy < 15) { spawnPop("ğŸ’¤ Too Tired", window.innerWidth/2, 200); return; }
  pet.stats.energy = Math.max(0, pet.stats.energy - 15);
  pet.stats.xp += 20;
  spawnPop("âš½ï¸ XP++", window.innerWidth/2, window.innerHeight/2);
  checkLevelUp(); updateUI(); save();
}

function doctorPet(e) {
  e.stopPropagation(); if(!pet || isSleeping || pet.stats.health <= 0) return;
  pet.stats.health = Math.min(100, pet.stats.health + 30);
  triggerFlash();
  spawnPop("ğŸ©º", window.innerWidth/2, window.innerHeight/2);
  updateUI(); save();
}

function checkLevelUp() {
  if(pet.stats.xp >= 100) { pet.stats.level++; pet.stats.xp = 0; display(pet); }
}

// --- SURVIVAL ---
function gameHeartbeat() {
  if (!pet || pet.stats.health <= 0) return;
  if (isSleeping) {
    pet.stats.energy = Math.min(100, pet.stats.energy + 10);
    spawnPop("ğŸ’¤", window.innerWidth/2, window.innerHeight/2);
  } else {
    pet.stats.hunger = Math.min(100, pet.stats.hunger + 2);
    pet.stats.energy = Math.max(0, pet.stats.energy - 1);
    if (pet.stats.hunger > 95 || pet.stats.energy <= 0) pet.stats.health = Math.max(0, pet.stats.health - 2);
  }
  updateUI(); save();
}
setInterval(gameHeartbeat, 5000);

// --- WEATHER & WIND ---
function toggleWeather() {
  const layer = document.getElementById('weather-layer');
  isRaining = Math.random() < 0.4;
  layer.innerHTML = '';
  if(isRaining) {
    document.body.classList.add('is-stormy');
    for(let i=0; i<40; i++) {
      const drop = document.createElement('div');
      drop.className = 'rain-drop'; drop.style.left = Math.random() * 100 + '%'; drop.style.animationDelay = Math.random() * 2 + 's';
      layer.appendChild(drop);
    }
    triggerLightningLoop();
  } else {
    document.body.classList.remove('is-stormy');
  }
}
function triggerLightningLoop() {
  if(!isRaining) return;
  setTimeout(() => { triggerFlash(); if(Math.random() > 0.7) triggerLightningLoop(); }, Math.random() * 10000 + 5000);
}
function triggerFlash() {
  const fl = document.getElementById('flash-layer');
  fl.classList.add('do-flash'); setTimeout(() => fl.classList.remove('do-flash'), 150);
}
setInterval(toggleWeather, 30000);

// --- CORE ---
async function initAudio() {
  if(audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  gainNode = audioCtx.createGain(); gainNode.connect(audioCtx.destination);
  const res = await fetch('happy-day.mp3'); const ab = await res.arrayBuffer();
  const buffer = await audioCtx.decodeAudioData(ab);
  musicSource = audioCtx.createBufferSource(); musicSource.buffer = buffer; musicSource.loop = true;
  musicSource.connect(gainNode); musicSource.start(0);
  gainNode.gain.value = 0.4;
}
function setVol(val,e){ e.stopPropagation(); if(!audioCtx) initAudio(); if(audioCtx.state==='suspended') audioCtx.resume(); gainNode.gain.setTargetAtTime(val, audioCtx.currentTime, 0.2); }

function toggleSleep(e) {
  e.stopPropagation(); isSleeping = !isSleeping;
  document.getElementById('night-overlay').style.opacity = isSleeping ? "1" : "0";
  if(gainNode) gainNode.gain.setTargetAtTime(isSleeping ? 0.05 : 0.4, audioCtx.currentTime, 1.5);
  updateUI(); save();
}

function display(data){
  pet = data; const world = document.getElementById("game-world");
  world.classList.toggle("wander", pet.stats.health > 0 && !isSleeping);
  world.innerHTML = `<img src="${pet.species}.png" class="pet-img" style="width:${80+(pet.stats.level*5)}px">`;
  updateUI();
}
function updateUI(){
  if(!pet) return; const s=pet.stats;
  document.getElementById("sn").innerHTML=`<b>${pet.name}</b>`;
  document.getElementById("sh").innerText=`H:${Math.round(s.hunger)}%`;
  document.getElementById("se").innerText=`E:${Math.round(s.energy)}%`;
  document.getElementById("shp").innerText=`HP:${Math.round(s.health)}%`;
}
async function save(){ if(pet?.id) await db.collection("pets").doc(pet.id).update({stats:pet.stats, lastUpdated:Date.now()}); }
function handlePetting(e){ if(!pet || isSleeping || pet.stats.health <= 0) return; if(e.target.classList.contains('pet-img')){ pet.stats.xp += 10; spawnPop("ğŸ’•", e.clientX, e.clientY); checkLevelUp(); save(); }}
function spawnPop(t,x,y){ const p=document.createElement("div"); p.className="pop"; p.innerText=t; p.style.left=x+"px"; p.style.top=y+"px"; document.body.appendChild(p); setTimeout(()=>p.remove(),1200); }
function toggleMenu(e){ e.stopPropagation(); const m=document.getElementById('createMenu'); m.style.display=(m.style.display==='block')?'none':'block'; if(m.style.display==='block') fetchHOF(); }
function switchTab(t) {
  ['helpTab','hofTab','adoptTab'].forEach(id => document.getElementById(id).style.display = id.startsWith(t) ? 'block' : 'none');
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.innerText.toLowerCase().includes(t)));
}
async function fetchHOF() {
  const snap = await db.collection("pets").orderBy("stats.level", "desc").limit(5).get();
  document.getElementById('hofList').innerHTML = snap.docs.map(d => `<div class="hof-entry"><span>${emojiMap[d.data().species]||'ğŸ¾'} ${d.data().name}</span><b>Lv.${d.data().stats.level}</b></div>`).join('');
}
async function createPet(){
  const n=document.getElementById("petName").value; const s=document.getElementById("petSpecies").value; if(!n) return;
  const res = await db.collection("pets").add({name:n,species:s,lastUpdated:Date.now(),stats:{hunger:50,energy:50,health:100,level:1,xp:0}});
  display({id:res.id,name:n,species:s,stats:{hunger:50,energy:50,health:100,level:1,xp:0}});
  document.getElementById('createMenu').style.display='none';
}
async function fetchPet(){
  const snap=await db.collection("pets").orderBy("lastUpdated","desc").limit(1).get();
  if(!snap.empty) display({id:snap.docs[0].id,...snap.docs[0].data()});
}
fetchPet();
</script>
</body>
</html>
