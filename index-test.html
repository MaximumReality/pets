<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Reality Pets: Atmospheric Legends</title>
<style>
:root { 
  --glass: rgba(0, 0, 0, 0.85); 
  --gold: #ffcc00;
  --safe-top: env(safe-area-inset-top, 59px); 
  --safe-bottom: env(safe-area-inset-bottom, 50px);
}

body {
  margin: 0; font-family: -apple-system, sans-serif;
  background: #1a1a1a url('bg_wp.jpg') no-repeat center center fixed;
  background-size: cover; color: #fff; 
  height: 100vh; overflow: hidden; position: fixed; width: 100%;
  touch-action: manipulation;
}

/* FULL SCREEN EFFECTS */
#night-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0, 5, 20, 0.75); pointer-events: none;
  opacity: 0; transition: opacity 1.5s; z-index: 9999;
}
.flash-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: white; opacity: 0; pointer-events: none; z-index: 10001;
}
.do-flash { animation: lightningStrike 0.15s ease-out; }
@keyframes lightningStrike { 0% { opacity: 1; } 100% { opacity: 0; } }

/* WEATHER & MESSES */
#weather-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }
.rain-drop { position: absolute; background: #4fa1ff; width: 2px; height: 15px; opacity: 0.6; animation: rainFall 0.8s linear infinite; }
@keyframes rainFall { 0% { transform: translateY(-100px); } 100% { transform: translateY(100vh); } }
.mess { position: absolute; font-size: 28px; z-index: 6; pointer-events: none; transition: opacity 0.5s; }

/* HUD */
#hud-container { position: absolute; top: calc(var(--safe-top) + 10px); left: 50%; transform: translateX(-50%); z-index: 10000; display: flex; flex-direction: column; align-items: center; gap: 10px; width: 90%; }
.hud-bar { background: var(--glass); padding: 8px 15px; border-radius: 25px; backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.15); display: flex; align-items: center; gap: 15px; }
#statsBox { display: flex; gap: 10px; font-size: 11px; font-weight: bold; }

/* TABBED MENU */
#createMenu {
  display: none; background: var(--glass); border-radius: 20px; width: 280px; 
  box-shadow: 0 10px 40px rgba(0,0,0,0.9); border: 1px solid var(--gold);
  z-index: 10002; overflow: hidden; margin-top: 10px;
}
.menu-tabs { display: flex; background: rgba(255,255,255,0.1); }
.tab-btn { flex: 1; padding: 10px; border: none; background: none; color: white; font-weight: bold; cursor: pointer; font-size: 11px; }
.tab-btn.active { border-bottom: 2px solid var(--gold); color: var(--gold); }
.menu-content { padding: 15px; max-height: 250px; overflow-y: auto; }

/* PET & EFFECTS */
#game-world { position: absolute; z-index: 50; transition: all 0.8s ease; text-align: center; }
.pet-img { filter: drop-shadow(0 0 10px rgba(255,255,255,0.3)); cursor: pointer; }
.wander { animation: wander 14s linear infinite alternate; }
@keyframes wander { 0% { transform: translate(-60px, 0); } 100% { transform: translate(60px, 0); } }

.food-drop { position: absolute; font-size: 45px; z-index: 50; animation: fall 1.2s ease-in forwards; }
@keyframes fall { 0% { transform: translateY(-50px); opacity: 1; } 100% { transform: translateY(500px); opacity: 0; } }
.pop { position: absolute; font-size: 35px; animation: popUp 1.2s forwards; z-index: 10001; pointer-events: none; }
@keyframes popUp { 0% { opacity: 1; } 100% { transform: translateY(-100px); opacity: 0; } }

.action-bar { position: absolute; bottom: calc(var(--safe-bottom) + 35px); left: 50%; transform: translateX(-50%); display: flex; gap: 12px; z-index: 10000; background: rgba(0,0,0,0.7); padding: 12px 18px; border-radius: 35px; backdrop-filter: blur(20px); }
.action-bar button { background: #222; border: 1px solid #444; color: white; border-radius: 50%; width: 54px; height: 54px; font-size: 26px; }

.hof-entry { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 12px; }
</style>
</head>
<body onclick="handlePetting(event)">

<div id="night-overlay"></div>
<div id="flash-layer" class="flash-overlay"></div>
<div id="weather-layer"></div>
<div id="messes"></div>

<div id="hud-container">
  <div class="hud-bar">
    <button style="background:none; border:none; font-size:20px;" onclick="toggleMenu(event)">âš™ï¸</button>
    <div id="statsBox">
      <div id="sn"><b>Loading...</b></div>
      <div id="sh">H:â€”</div><div id="se">E:â€”</div><div id="shp">HP:â€”</div>
    </div>
  </div>

  <div id="createMenu">
    <div class="menu-tabs">
      <button class="tab-btn active" onclick="switchTab('help')">Manual</button>
      <button class="tab-btn" onclick="switchTab('hof')">Legends</button>
      <button class="tab-btn" onclick="switchTab('adopt')">Adopt</button>
    </div>
    <div id="helpTab" class="menu-content">
      <p style="font-size:12px;"><b>H:</b> Hunger (Drop Food ğŸ)<br><b>E:</b> Energy (Sleep ğŸŒ™)<br><b>HP:</b> Health (Clean ğŸ§½ / Med ğŸ©º)</p>
    </div>
    <div id="hofTab" class="menu-content" style="display:none;"><div id="hofList">Loading...</div></div>
    <div id="adoptTab" class="menu-content" style="display:none;">
      <input id="petName" placeholder="Name" style="width:90%; margin-bottom:5px; background:#333; color:white; border:none; padding:8px; border-radius:5px;">
      <select id="petSpecies" style="width:90%; margin-bottom:5px; background:#333; color:white; border:none; padding:8px; border-radius:5px;">
        <option value="bunny">Bunny</option><option value="dragon">Dragon</option><option value="unicorn">Unicorn</option><option value="cat">Cat</option><option value="fox">Fox</option><option value="dog">Dog</option>
      </select>
      <button onclick="createPet()" style="width:100%; background:var(--gold); border:none; padding:10px; font-weight:bold; border-radius:5px;">ADOPT</button>
    </div>
  </div>

  <div class="audio-controls" style="display:flex; gap:10px; margin-top:5px; background:rgba(0,0,0,0.4); padding:5px 15px; border-radius:15px;">
    <button onclick="setVol(0, event)" style="background:none; border:none; color:white;">ğŸ”ˆ</button>
    <button onclick="setVol(0.3, event)" style="background:none; border:none; color:white;">ğŸ”‰</button>
    <button onclick="setVol(0.7, event)" style="background:none; border:none; color:white;">ğŸ”Š</button>
  </div>
</div>

<div id="game-world"></div>

<div class="action-bar">
  <button onclick="feedPet(event)">ğŸ</button>
  <button onclick="cleanPet(event)">ğŸ§½</button>
  <button onclick="playPet(event)">âš½ï¸</button>
  <button onclick="doctorPet(event)">ğŸ©º</button>
  <button onclick="toggleSleep(event)">ğŸŒ™</button>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = { apiKey:"AIzaSyDkpW7RAmX0wPmL757_GzEFIoU6snssLnA", authDomain:"pets-86c25.firebaseapp.com", projectId:"pets-86c25", storageBucket:"pets-86c25.firebasestorage.app", messagingSenderId:"556129222317", appId:"1:556129222d59024" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let pet = null, isSleeping = false, isRaining = false;
let audioCtx, gainNode, musicSource;
const foodMap = { bunny:"ğŸ¥•", fox:"ğŸ”", dog:"ğŸ¥©", dragon:"ğŸ–", cat:"ğŸ ", unicorn:"ğŸ", frog:"ğŸª°" };
const emojiMap = { bunny:"ğŸ°", fox:"ğŸ¦Š", dog:"ğŸ•", dragon:"ğŸ²", cat:"ğŸ±", unicorn:"ğŸ¦„", frog:"ğŸ¸" };

// --- ACTIONS ---
function feedPet(e) {
  e.stopPropagation(); if(!pet || isSleeping || pet.stats.health <= 0) return;
  pet.stats.hunger = Math.max(0, pet.stats.hunger - 20);
  const f = document.createElement("div"); f.className = "food-drop"; f.innerText = foodMap[pet.species] || "ğŸ";
  f.style.left = "50%"; document.body.appendChild(f); setTimeout(()=>f.remove(), 1200);
  save();
}

function cleanPet(e) {
  e.stopPropagation(); if(!pet || pet.stats.health <= 0) return;
  pet.stats.health = Math.min(100, pet.stats.health + 10);
  document.querySelectorAll('.mess').forEach(m => m.style.opacity = '0');
  setTimeout(() => document.getElementById('messes').innerHTML = '', 500);
  spawnPop("ğŸ«§", window.innerWidth/2, window.innerHeight/2);
  save();
}

function playPet(e) {
  e.stopPropagation(); if(!pet || isSleeping || pet.stats.health <= 0) return;
  if(pet.stats.energy < 15) { spawnPop("ğŸ’¤ Need Sleep", window.innerWidth/2, 200); return; }
  pet.stats.energy = Math.max(0, pet.stats.energy - 15);
  pet.stats.xp += 20;
  spawnPop("âš½ï¸ XP++", window.innerWidth/2, window.innerHeight/2);
  checkLevelUp();
  save();
}

function doctorPet(e) {
  e.stopPropagation(); if(!pet || isSleeping || pet.stats.health <= 0) return;
  pet.stats.health = Math.min(100, pet.stats.health + 30);
  triggerFlash();
  spawnPop("ğŸ©º", window.innerWidth/2, window.innerHeight/2);
  save();
}

function checkLevelUp() {
  if(pet.stats.xp >= 100) {
    pet.stats.level++; pet.stats.xp = 0;
    spawnPop("âœ¨ LEVEL UP", window.innerWidth/2, 150);
    display(pet);
  }
}

// --- WORLD EFFECTS ---
function triggerFlash() {
  const flashLayer = document.getElementById('flash-layer');
  flashLayer.classList.add('do-flash');
  setTimeout(() => flashLayer.classList.remove('do-flash'), 150);
}

function toggleWeather() {
  const layer = document.getElementById('weather-layer');
  isRaining = Math.random() < 0.3;
  layer.innerHTML = '';
  if(isRaining) {
    for(let i=0; i<30; i++) {
      const drop = document.createElement('div');
      drop.className = 'rain-drop'; drop.style.left = Math.random() * 100 + '%'; drop.style.animationDelay = Math.random() * 2 + 's';
      layer.appendChild(drop);
    }
    triggerLightningLoop();
  }
}

function triggerLightningLoop() {
  if(!isRaining) return;
  setTimeout(() => { triggerFlash(); if(Math.random() > 0.7) triggerLightningLoop(); }, Math.random() * 10000 + 5000);
}
setInterval(toggleWeather, 30000);

// --- CORE ---
async function initAudio() {
  if(audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  gainNode = audioCtx.createGain(); gainNode.connect(audioCtx.destination);
  const res = await fetch('happy-day.mp3'); const ab = await res.arrayBuffer();
  const buffer = await audioCtx.decodeAudioData(ab);
  musicSource = audioCtx.createBufferSource(); musicSource.buffer = buffer; musicSource.loop = true;
  musicSource.connect(gainNode); musicSource.start(0);
  gainNode.gain.value = 0.4;
}

function setVol(val,e){ e.stopPropagation(); if(!audioCtx) initAudio(); if(audioCtx.state==='suspended') audioCtx.resume(); gainNode.gain.setTargetAtTime(val, audioCtx.currentTime, 0.2); }

function toggleSleep(e) {
  e.stopPropagation(); isSleeping = !isSleeping;
  const overlay = document.getElementById('night-overlay');
  overlay.style.opacity = isSleeping ? "1" : "0";
  if(gainNode) gainNode.gain.setTargetAtTime(isSleeping ? 0.05 : 0.4, audioCtx.currentTime, 1.5);
  if(isSleeping) spawnPop("ğŸ’¤", window.innerWidth/2, window.innerHeight/2);
  save();
}

function toggleMenu(e){ e.stopPropagation(); const m=document.getElementById('createMenu'); m.style.display=(m.style.display==='block')?'none':'block'; if(m.style.display==='block') fetchHOF(); }
function switchTab(t) {
  ['helpTab','hofTab','adoptTab'].forEach(id => document.getElementById(id).style.display = id.startsWith(t) ? 'block' : 'none');
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.innerText.toLowerCase().includes(t)));
}

async function fetchHOF() {
  const snap = await db.collection("pets").orderBy("stats.level", "desc").limit(5).get();
  document.getElementById('hofList').innerHTML = snap.docs.map(d => `<div class="hof-entry"><span>${emojiMap[d.data().species]||'ğŸ¾'} ${d.data().name}</span><b>Lv.${d.data().stats.level}</b></div>`).join('');
}

function display(data){
  pet = data; const world = document.getElementById("game-world");
  world.style.left="50%"; world.style.bottom="32%";
  world.classList.toggle("wander", pet.stats.health > 0 && !isSleeping);
  world.innerHTML = `<img src="${pet.species}.png" class="pet-img" style="width:${80+(pet.stats.level*5)}px">`;
  updateUI();
}

function updateUI(){
  if(!pet) return; const s=pet.stats;
  document.getElementById("sn").innerHTML=`<b>${pet.name}</b>`;
  document.getElementById("sh").innerText=`H:${Math.round(s.hunger)}%`;
  document.getElementById("se").innerText=`E:${Math.round(s.energy)}%`;
  document.getElementById("shp").innerText=`HP:${Math.round(s.health)}%`;
}

async function save(){ if(pet?.id) await db.collection("pets").doc(pet.id).update({stats:pet.stats, lastUpdated:Date.now()}); }

function handlePetting(e){ if(!pet || isSleeping || pet.stats.health <= 0) return; if(e.target.classList.contains('pet-img')){ pet.stats.xp += 10; spawnPop("ğŸ’•", e.clientX, e.clientY); checkLevelUp(); save(); }}

function spawnPop(t,x,y){ const p=document.createElement("div"); p.className="pop"; p.innerText=t; p.style.left=x+"px"; p.style.top=y+"px"; document.body.appendChild(p); setTimeout(()=>p.remove(),1200); }

async function createPet(){
  const n=document.getElementById("petName").value; const s=document.getElementById("petSpecies").value; if(!n) return;
  const res = await db.collection("pets").add({name:n,species:s,lastUpdated:Date.now(),stats:{hunger:50,energy:50,health:100,level:1,xp:0}});
  display({id:res.id,name:n,species:s,stats:{hunger:50,energy:50,health:100,level:1,xp:0}});
  document.getElementById('createMenu').style.display='none';
}

async function fetchPet(){
  const snap=await db.collection("pets").orderBy("lastUpdated","desc").limit(1).get();
  if(!snap.empty) display({id:snap.docs[0].id,...snap.docs[0].data()});
}

fetchPet();
setInterval(() => { if(pet && !isSleeping) { pet.stats.hunger = Math.min(100, pet.stats.hunger+2); updateUI(); save(); }}, 5000);
</script>
</body>
</html>
