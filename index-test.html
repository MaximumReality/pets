<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Reality Pets: Command Center</title>
<style>
:root {
  --glass: rgba(0,0,0,0.85);
  --gold: #ffcc00;
  --safe-top: env(safe-area-inset-top, 20px);
  --safe-bottom: env(safe-area-inset-bottom, 30px);
}

html, body {
  margin:0; padding:0;
  width: 100%; height: 100%;
  overflow: hidden; position: fixed;
  touch-action: manipulation;
  font-family:-apple-system,sans-serif;
  background:#1a1a1a url('bg_wp.jpg') no-repeat center center fixed;
  background-size:cover; color:#fff;
  transition: background 1s;
}
.flash { background:white !important; transition: background 0.1s; }

/* LAYERING */
#star-field { position: absolute; top: 0; left: 0; width: 100%; pointer-events: none; z-index: 1; }
#weather-layer { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:5; }
#game-world { position:absolute; z-index:50; transition:all 0.8s ease; }

/* HUD - Z-INDEX 10000 */
#hud-container {
  position:absolute; top:calc(var(--safe-top) + 10px); left:50%; transform:translateX(-50%);
  z-index:10000; display:flex; flex-direction:column; align-items:center; gap:12px; width: 90%;
}
.hud-bar {
  background:var(--glass); padding:10px 18px; border-radius:30px; backdrop-filter:blur(15px);
  border:1px solid rgba(255,255,255,0.15); display:flex; align-items:center; gap:15px;
}
#statsBox { display:flex; gap:12px; font-size:12px; font-weight:bold; white-space: nowrap; }
.gear-btn { background:none; border:none; font-size:22px; cursor:pointer; padding:0; }

.audio-controls {
  display:flex; gap:15px; background:rgba(0,0,0,0.6); padding:6px 20px; border-radius:20px;
  border: 1px solid rgba(255,255,255,0.1);
}
.audio-controls button { background:none; border:none; color:white; font-size: 18px; }

#createMenu {
  display:none; background:var(--glass); padding:20px; border-radius:20px;
  width:220px; box-shadow:0 10px 40px rgba(0,0,0,0.9); border:1px solid var(--gold);
}
#createMenu input, #createMenu select { width:100%; margin-bottom:10px; padding:10px; border-radius:8px; border:none; font-size: 16px; }

/* PET & ANIMATIONS */
.pet-img { filter:drop-shadow(0 0 10px rgba(255,255,255,0.3)); cursor:pointer; }
.wander { animation:wander 14s linear infinite alternate; }
@keyframes wander { 0%{transform:translate(-60px,0);} 100%{transform:translate(60px,0);} }

.hud-star {
  position: absolute; pointer-events: none; font-size: 14px; 
  animation: starTwinkle 2.5s ease-in-out infinite alternate; opacity: 0;
}
@keyframes starTwinkle { 0% { transform: scale(0.6); opacity: 0.2; } 100% { transform: scale(1.3); opacity: 1; } }

.action-bar {
  position:absolute; bottom:calc(var(--safe-bottom) + 20px); left:50%; transform:translateX(-50%);
  display:flex; gap:14px; z-index:10000; background:rgba(0,0,0,0.8); padding:15px 20px; border-radius:40px;
  backdrop-filter:blur(20px); border:1px solid rgba(255,255,255,0.1);
}
.action-bar button { background:#2a2a2a; border:1px solid #444; color:white; border-radius:50%; width:56px; height:56px; font-size:28px; }

.pop { position:absolute; font-size:35px; animation:popUp 1.2s forwards; z-index:10001; pointer-events:none; }
@keyframes popUp { 0%{opacity:1;} 100%{transform:translateY(-100px); opacity:0;} }

.night-mode {
  background-image: linear-gradient(rgba(0,0,50,0.6), rgba(0,0,50,0.6)), url('bg_wp.jpg') !important;
  filter: brightness(0.7) saturate(0.9);
}

/* Save Indicator Pulse */
.saving { color: var(--gold); text-shadow: 0 0 10px var(--gold); transition: 0.3s; }
</style>
</head>
<body onclick="handlePetting(event)">

<div id="star-field"></div>
<div id="weather-layer"></div>
<div id="messes"></div>

<div id="hud-container">
  <div class="hud-bar">
    <button class="gear-btn" onclick="toggleMenu(event)">‚öôÔ∏è</button>
    <div id="statsBox">
      <div id="sn"><b>Adopt!</b></div>
      <div id="sh">H:‚Äî</div><div id="se">E:‚Äî</div><div id="shp">HP:‚Äî</div>
    </div>
  </div>
  
  <div class="audio-controls">
    <button onclick="setVol(0,event)">üîà</button>
    <button onclick="setVol(0.3,event)">üîâ</button>
    <button onclick="setVol(0.7,event)">üîä</button>
  </div>

  <div id="createMenu">
    <input id="petName" placeholder="Pet Name">
    <select id="petSpecies">
      <option value="bunny">Bunny</option><option value="fox">Fox</option>
      <option value="dog">Dog</option><option value="dragon">Dragon</option>
      <option value="cat">Cat</option><option value="unicorn">Unicorn</option>
      <option value="frog">Frog</option>
    </select>
    <button onclick="createPet()" style="width:100%; background:var(--gold); border:none; padding:12px; border-radius:10px; font-weight:bold; color:black;">ADOPT</button>
  </div>
</div>

<div id="game-world"></div>

<div class="action-bar">
  <button onclick="feedPet(event)">üçé</button>
  <button onclick="cleanPet(event)">üßΩ</button>
  <button onclick="playPet(event)">‚öΩÔ∏è</button>
  <button onclick="doctorPet(event)">ü©∫</button>
  <button id="resBtn" onclick="resurrectPet(event)" style="display:none; background:var(--gold); color:black;">‚ö°Ô∏è</button>
  <button onclick="toggleSleep(event)">üåô</button>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

<script>
// CONFIG
const firebaseConfig = { apiKey:"AIzaSyDkpW7RAmX0wPmL757_GzEFIoU6snssLnA", authDomain:"pets-86c25.firebaseapp.com", projectId:"pets-86c25", storageBucket:"pets-86c25.firebasestorage.app", messagingSenderId:"556129222317", appId:"1:556129222d59024" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let pet=null, isSleeping=false, isRaining=false;
let audioCtx, gainNode, rainGain;
const foodMap={bunny:"ü•ï",fox:"üçî",dog:"ü•©",dragon:"üçñ",cat:"üê†",unicorn:"üçé",frog:"ü™∞"};
const reactMap={bunny:"üê∞",fox:"ü¶ä",dog:"üêï",cat:"üòº",frog:"üê∏",dragon:"üî•",unicorn:"‚ú®"};
const petPositions={frog:{left:"25%",bottom:"25%"},bunny:{left:"65%",bottom:"28%"},fox:{left:"55%",bottom:"30%"},dog:{left:"50%",bottom:"32%"},cat:{left:"45%",bottom:"34%"},unicorn:{left:"70%",bottom:"36%"},dragon:{left:"50%",bottom:"60%"}};

// CORE LOGIC
function checkLevelUp() {
  if(!pet) return;
  if(pet.stats.xp >= 100) {
    pet.stats.level++;
    pet.stats.xp = 0;
    spawnPop("‚ú® LEVEL UP!", window.innerWidth/2, 150);
    display(pet);
  }
}

async function save(){ 
  if(pet && pet.id) {
    const box = document.getElementById('statsBox');
    box.classList.add('saving');
    await db.collection("pets").doc(pet.id).update({stats:pet.stats, lastUpdated:Date.now()});
    setTimeout(() => box.classList.remove('saving'), 500);
  }
  updateUI(); 
}

// AUDIO & WEATHER
async function initAudio() {
  if (audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  gainNode = audioCtx.createGain();
  gainNode.connect(audioCtx.destination);
  rainGain = audioCtx.createGain();
  rainGain.connect(audioCtx.destination);
  // Music logic would go here
}

function setVol(val, e) {
  if (e) e.stopPropagation();
  if (!audioCtx) initAudio();
  if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
  if (gainNode) gainNode.gain.setTargetAtTime(val, audioCtx.currentTime, 0.2);
}

function toggleWeather() {
  const layer = document.getElementById('weather-layer');
  layer.innerHTML = '';
  isRaining = Math.random() < 0.4; 
  if (isRaining) {
    for (let i = 0; i < 30; i++) {
      const drop = document.createElement('div');
      drop.className = 'rain-drop';
      drop.style.left = Math.random() * 100 + '%';
      drop.style.animationDelay = Math.random() * 2 + 's';
      layer.appendChild(drop);
    }
    triggerLightning();
    spawnPop("‚õàÔ∏è", window.innerWidth/2, 100);
  }
}
function triggerLightning() {
  if (!isRaining) return;
  setTimeout(() => {
    if (isRaining) {
      document.body.classList.add('flash');
      setTimeout(() => document.body.classList.remove('flash'), 150);
      triggerLightning();
    }
  }, Math.random() * 8000 + 3000);
}
setInterval(toggleWeather, 60000);

// PET ACTIONS
function feedPet(e){ e.stopPropagation(); if(!pet || isSleeping || pet.stats.health <= 0) return; pet.stats.hunger = Math.max(0, pet.stats.hunger - 25); spawnPop(foodMap[pet.species] || "üçé", window.innerWidth/2, window.innerHeight/2); save(); }
function playPet(e){ e.stopPropagation(); if(!pet || isSleeping || pet.stats.health <= 0) return; if(pet.stats.energy < 15) { spawnPop("üí§", window.innerWidth/2, 200); return; } pet.stats.energy = Math.max(0, pet.stats.energy - 10); pet.stats.xp += 30; spawnPop("‚öΩÔ∏è", window.innerWidth/2, window.innerHeight/2); checkLevelUp(); save(); }
function cleanPet(e){ e.stopPropagation(); if(!pet || pet.stats.health <= 0) return; pet.stats.health = Math.min(100, pet.stats.health + 15); document.getElementById('messes').innerHTML = ''; spawnPop("ü´ß", window.innerWidth/2, window.innerHeight/2); save(); }
function doctorPet(e){ e.stopPropagation(); if(!pet || isSleeping || pet.stats.health <= 0) return; pet.stats.health = Math.min(100, pet.stats.health + 30); spawnPop("ü©∫", window.innerWidth/2, window.innerHeight/2); save(); }
function toggleSleep(e){ e.stopPropagation(); isSleeping = !isSleeping; document.body.classList.toggle('night-mode', isSleeping); isSleeping ? spawnStars() : removeStars(); save(); }

function spawnStars() {
  const field = document.getElementById('star-field');
  field.innerHTML = '';
  for (let i = 0; i < 20; i++) {
    const star = document.createElement('div'); star.className = 'hud-star';
    star.innerText = '‚ú®'; star.style.top = Math.random() * 50 + '%'; star.style.left = Math.random() * 100 + '%';
    field.appendChild(star);
  }
}
function removeStars() { document.getElementById('star-field').innerHTML = ''; }

function handlePetting(e){ if(!pet || isSleeping || pet.stats.health <= 0) return; if(e.target.classList.contains('pet-img')){ pet.stats.xp += 5; spawnPop(reactMap[pet.species]||"üíï", e.clientX, e.clientY); checkLevelUp(); save(); } }

function display(data){
  pet=data; const world=document.getElementById("game-world");
  const pos=petPositions[pet.species]||{left:"50%",bottom:"32%"};
  world.style.left=pos.left; world.style.bottom=pos.bottom;
  const isDead = pet.stats.health <= 0;
  world.classList.toggle("wander", !isDead && !isSleeping);
  world.innerHTML=`<img src="${pet.species}.png" class="pet-img" style="width:${80+(pet.stats.level*5)}px; opacity:${isDead?0.4:1}">`;
  updateUI();
}

function updateUI(){
  if(!pet) return; const s=pet.stats;
  document.getElementById("sn").innerHTML=`<b>${pet.name}</b> Lv.${s.level}`;
  document.getElementById("sh").innerText=`H:${Math.round(s.hunger)}%`;
  document.getElementById("se").innerText=`E:${Math.round(s.energy)}%`;
  document.getElementById("shp").innerText=`HP:${Math.round(s.health)}%`;
}

function spawnPop(txt,x,y){
  const p=document.createElement("div"); p.className="pop"; p.innerText=txt; 
  p.style.left=x+"px"; p.style.top=y+"px"; 
  document.body.appendChild(p); setTimeout(()=>p.remove(),1200);
}

function toggleMenu(e){ e.stopPropagation(); const m=document.getElementById('createMenu'); m.style.display=(m.style.display==='block')?'none':'block'; }

async function createPet(){
  const n=document.getElementById("petName").value; const s=document.getElementById("petSpecies").value; if(!n) return;
  const res=await db.collection("pets").add({name:n,species:s,lastUpdated:Date.now(),stats:{hunger:50,energy:50,health:100,level:1,xp:0}});
  display({id:res.id,name:n,species:s,stats:{hunger:50,energy:50,health:100,level:1,xp:0}});
  document.getElementById('createMenu').style.display='none';
}

async function fetchPet(){
  const snap=await db.collection("pets").orderBy("lastUpdated","desc").limit(1).get();
  if(!snap.empty) display({id:snap.docs[0].id,...snap.docs[0].data()});
}
fetchPet();
</script>
</body>
</html>
