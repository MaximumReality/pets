<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Reality Pets: Master Edition</title>
<style>
:root {
  --glass: rgba(0,0,0,0.85);
  --gold: #ffcc00;
  --safe-top: env(safe-area-inset-top, 20px);
  --safe-bottom: env(safe-area-inset-bottom, 30px);
}

html, body {
  margin:0; padding:0; width: 100%; height: 100%;
  overflow: hidden; position: fixed; touch-action: manipulation;
  font-family:-apple-system,sans-serif;
  background:#1a1a1a url('bg_wp.jpg') no-repeat center center fixed;
  background-size:cover; color:#fff; transition: background 1s;
}

/* HUD & MENU */
#hud-container { position:absolute; top:calc(var(--safe-top) + 10px); left:50%; transform:translateX(-50%); z-index:10000; display:flex; flex-direction:column; align-items:center; gap:12px; width: 90%; }
.hud-bar { background:var(--glass); padding:10px 18px; border-radius:30px; backdrop-filter:blur(15px); border:1px solid rgba(255,255,255,0.15); display:flex; align-items:center; gap:15px; }
#statsBox { display:flex; gap:12px; font-size:12px; font-weight:bold; }

.audio-controls { display:flex; gap:15px; background:rgba(0,0,0,0.6); padding:6px 20px; border-radius:20px; border: 1px solid rgba(255,255,255,0.1); }
.audio-controls button { background:none; border:none; color:white; font-size: 18px; }

#createMenu {
  display:none; background:var(--glass); border-radius:20px; width:300px; 
  box-shadow:0 10px 40px rgba(0,0,0,0.9); border:1px solid var(--gold);
  z-index: 10002; overflow: hidden;
}
.menu-tabs { display: flex; background: rgba(255,255,255,0.1); }
.tab-btn { flex: 1; padding: 12px; border: none; background: none; color: white; font-weight: bold; cursor: pointer; font-size: 11px; }
.tab-btn.active { border-bottom: 2px solid var(--gold); color: var(--gold); }
.menu-content { padding: 15px; max-height: 300px; overflow-y: auto; }

/* PET WORLD */
#game-world { position:absolute; z-index:50; transition:all 0.8s ease; text-align: center; }
.pet-img { filter:drop-shadow(0 0 10px rgba(255,255,255,0.3)); cursor:pointer; transition: filter 0.5s; }
.wander { animation:wander 14s linear infinite alternate; }
@keyframes wander { 0%{transform:translate(-60px,0);} 100%{transform:translate(60px,0);} }

.action-bar { position:absolute; bottom:calc(var(--safe-bottom) + 20px); left:50%; transform:translateX(-50%); display:flex; gap:14px; z-index:10000; background:rgba(0,0,0,0.8); padding:15px 20px; border-radius:40px; }
.action-bar button { background:#2a2a2a; border:1px solid #444; color:white; border-radius:50%; width:56px; height:56px; font-size:28px; }

.pop { position:absolute; font-size:35px; animation:popUp 1.2s forwards; z-index:10001; pointer-events:none; }
@keyframes popUp { 0%{opacity:1;} 100%{transform:translateY(-100px); opacity:0;} }
.night-mode { filter: brightness(0.6) hue-rotate(20deg); }
.hof-entry { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 14px; }
</style>
</head>
<body onclick="handlePetting(event)">

<div id="messes"></div>

<div id="hud-container">
  <div class="hud-bar">
    <button style="background:none; border:none; font-size:22px;" onclick="toggleMenu(event)">âš™ï¸</button>
    <div id="statsBox">
      <div id="sn"><b>Loading...</b></div>
      <div id="sh">H:â€”</div><div id="se">E:â€”</div><div id="shp">HP:â€”</div>
    </div>
  </div>
  
  <div class="audio-controls">
    <button onclick="setVol(0,event)">ğŸ”ˆ</button>
    <button onclick="setVol(0.3,event)">ğŸ”‰</button>
    <button onclick="setVol(0.7,event)">ğŸ”Š</button>
  </div>

  <div id="createMenu">
    <div class="menu-tabs">
      <button class="tab-btn active" onclick="switchTab('help')">Manual</button>
      <button class="tab-btn" onclick="switchTab('hof')">Legends</button>
      <button class="tab-btn" onclick="switchTab('adopt')">Adopt</button>
    </div>
    <div id="helpTab" class="menu-content">
      <p><b>H:</b> Hunger (Feed ğŸ) | <b>E:</b> Energy (Sleep ğŸŒ™)</p>
      <p><b>HP:</b> Health (Doctor ğŸ©º) | <b>XP:</b> Pet to LvUp!</p>
    </div>
    <div id="hofTab" class="menu-content" style="display:none;">
      <div id="hofList">Loading...</div>
    </div>
    <div id="adoptTab" class="menu-content" style="display:none;">
      <input id="petName" placeholder="Name" style="width:80%; padding:8px; margin-bottom:10px;">
      <select id="petSpecies" style="width:80%; padding:8px; margin-bottom:10px;">
        <option value="bunny">Bunny</option><option value="dragon">Dragon</option><option value="unicorn">Unicorn</option><option value="cat">Cat</option>
      </select>
      <button onclick="createPet()" style="width:100%; padding:10px; background:var(--gold); border:none; font-weight:bold;">START</button>
    </div>
  </div>
</div>

<div id="game-world"></div>

<div class="action-bar">
  <button onclick="feedPet(event)">ğŸ</button>
  <button onclick="cleanPet(event)">ğŸ§½</button>
  <button onclick="playPet(event)">âš½ï¸</button>
  <button onclick="doctorPet(event)">ğŸ©º</button>
  <button onclick="toggleSleep(event)">ğŸŒ™</button>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = { apiKey:"AIzaSyDkpW7RAmX0wPmL757_GzEFIoU6snssLnA", authDomain:"pets-86c25.firebaseapp.com", projectId:"pets-86c25", storageBucket:"pets-86c25.firebasestorage.app", messagingSenderId:"556129222317", appId:"1:556129222d59024" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let pet=null, isSleeping=false;
let audioCtx, musicGain, musicBuffer, musicSource;
const foodMap={bunny:"ğŸ¥•",fox:"ğŸ”",dog:"ğŸ¥©",dragon:"ğŸ–",cat:"ğŸ ",unicorn:"ğŸ",frog:"ğŸª°"};
const emojiMap={bunny:"ğŸ°",fox:"ğŸ¦Š",dog:"ğŸ•",dragon:"ğŸ²",cat:"ğŸ±",unicorn:"ğŸ¦„",frog:"ğŸ¸"};

// --- AUDIO LOGIC ---
async function initAudio() {
  if (audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  musicGain = audioCtx.createGain();
  musicGain.connect(audioCtx.destination);
  try {
    const res = await fetch('happy-day.mp3');
    const ab = await res.arrayBuffer();
    musicBuffer = await audioCtx.decodeAudioData(ab);
    musicSource = audioCtx.createBufferSource();
    musicSource.buffer = musicBuffer;
    musicSource.loop = true;
    musicSource.connect(musicGain);
    musicSource.start(0);
    musicGain.gain.value = 0.4;
  } catch(e) { console.log("Audio load failed."); }
}

function setVol(val, e) {
  if (e) e.stopPropagation();
  if (!audioCtx) initAudio();
  else { if(audioCtx.state==='suspended') audioCtx.resume(); musicGain.gain.setTargetAtTime(val, audioCtx.currentTime, 0.2); }
}

// --- CORE ENGINE ---
function updateMood() {
  if(!pet) return;
  const img = document.querySelector('.pet-img');
  if(!img) return;
  let f = "drop-shadow(0 0 10px rgba(255,255,255,0.3))";
  if(pet.stats.health <= 0) f += " grayscale(1) opacity(0.5)";
  else if(pet.stats.hunger > 75) f += " hue-rotate(-50deg) saturate(3)"; // Angry
  else if(pet.stats.energy < 25) f += " brightness(0.7) saturate(0.5)"; // Tired
  img.style.filter = f;
}

function feedPet(e) {
  e.stopPropagation(); if(!pet || isSleeping || pet.stats.health <= 0) return;
  pet.stats.hunger = Math.max(0, pet.stats.hunger - 25);
  spawnPop(foodMap[pet.species] || "ğŸ", window.innerWidth/2, window.innerHeight/2);
  save();
}

function gameHeartbeat() {
  if (!pet || pet.stats.health <= 0) return;
  if (isSleeping) { pet.stats.energy = Math.min(100, pet.stats.energy + 8); pet.stats.health = Math.min(100, pet.stats.health + 1); }
  else {
    pet.stats.hunger = Math.min(100, pet.stats.hunger + 2);
    pet.stats.energy = Math.max(0, pet.stats.energy - 1);
    if (pet.stats.hunger > 90 || pet.stats.energy < 5) pet.stats.health = Math.max(0, pet.stats.health - 2);
  }
  updateUI(); updateMood(); save();
}
setInterval(gameHeartbeat, 5000);

async function save(){ if(pet?.id) await db.collection("pets").doc(pet.id).update({stats:pet.stats, lastUpdated:Date.now()}); }

function updateUI(){
  if(!pet) return; const s=pet.stats;
  document.getElementById("sn").innerHTML=`<b>${pet.name}</b> Lv.${s.level}`;
  document.getElementById("sh").innerText=`H:${Math.round(s.hunger)}%`;
  document.getElementById("se").innerText=`E:${Math.round(s.energy)}%`;
  document.getElementById("shp").innerText=`HP:${Math.round(s.health)}%`;
}

function display(data){
  pet=data; const world=document.getElementById("game-world");
  world.style.left="50%"; world.style.bottom="32%";
  world.classList.toggle("wander", pet.stats.health > 0 && !isSleeping);
  world.innerHTML=`<img src="${pet.species}.png" class="pet-img" style="width:${80+(pet.stats.level*5)}px">`;
  updateUI(); updateMood();
}

// --- TABS & UTILS ---
function toggleMenu(e){ e.stopPropagation(); const m=document.getElementById('createMenu'); m.style.display=(m.style.display==='block')?'none':'block'; if(m.style.display==='block') fetchHOF(); }
function switchTab(t) {
  ['helpTab','hofTab','adoptTab'].forEach(id => document.getElementById(id).style.display = id.startsWith(t) ? 'block' : 'none');
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.innerText.toLowerCase().includes(t)));
}
async function fetchHOF() {
  const snap = await db.collection("pets").orderBy("stats.level", "desc").limit(5).get();
  document.getElementById('hofList').innerHTML = snap.docs.map(d => {
    const p = d.data();
    return `<div class="hof-entry"><span>${emojiMap[p.species]||'ğŸ¾'} ${p.name}</span><b>Lv.${p.stats.level}</b></div>`;
  }).join('');
}
function spawnPop(t,x,y){ const p=document.createElement("div"); p.className="pop"; p.innerText=t; p.style.left=x+"px"; p.style.top=y+"px"; document.body.appendChild(p); setTimeout(()=>p.remove(),1200); }
function toggleSleep(e){ e.stopPropagation(); isSleeping = !isSleeping; document.body.classList.toggle('night-mode', isSleeping); save(); }
function handlePetting(e){ if(!pet || isSleeping || pet.stats.health <= 0) return; if(e.target.classList.contains('pet-img')){ pet.stats.xp += 5; spawnPop("ğŸ’•", e.clientX, e.clientY); if(pet.stats.xp>=100){pet.stats.level++; pet.stats.xp=0; display(pet);} save(); } }

async function createPet(){
  const n=document.getElementById("petName").value; const s=document.getElementById("petSpecies").value; if(!n) return;
  const res = await db.collection("pets").add({name:n,species:s,lastUpdated:Date.now(),stats:{hunger:50,energy:50,health:100,level:1,xp:0}});
  display({id:res.id,name:n,species:s,stats:{hunger:50,energy:50,health:100,level:1,xp:0}});
  document.getElementById('createMenu').style.display='none';
}
async function fetchPet(){
  const snap=await db.collection("pets").orderBy("lastUpdated","desc").limit(1).get();
  if(!snap.empty) display({id:snap.docs[0].id,...snap.docs[0].data()});
}
fetchPet();
</script>
</body>
</html>
